<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GRASIAS</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
* {
    box-sizing: border-box;
}

body {
    font-family: 'Cairo', sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    margin: 0;
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    direction: rtl;
    padding: 20px;
}

.box {
    background: white;
    padding: 30px 25px;
    border-radius: 20px;
    box-shadow: 0 15px 50px rgba(0,0,0,0.2);
    width: 100%;
    max-width: 400px;
    text-align: center;
    animation: fadeIn 0.6s ease-in-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

h2 {
    margin-bottom: 25px;
    color: #4a5568;
    font-weight: 600;
    font-size: 24px;
}

input, button, textarea, select {
    width: 100%;
    padding: 15px;
    border-radius: 12px;
    margin-bottom: 15px;
    font-size: 16px;
    border: 2px solid #e2e8f0;
    transition: all 0.3s ease;
    font-family: 'Cairo', sans-serif;
}

input:focus, textarea:focus, select:focus {
    border-color: #667eea;
    outline: none;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

button {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    cursor: pointer;
    font-weight: 600;
    transition: transform 0.2s ease;
}

button:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
}

button:active {
    transform: translateY(0);
}

.choice {
    text-align: right;
    margin: 25px 0;
}

.choice label {
    display: flex;
    align-items: center;
    margin-bottom: 12px;
    font-size: 16px;
    cursor: pointer;
    padding: 10px;
    border-radius: 8px;
    transition: background-color 0.2s ease;
}

.choice label:hover {
    background-color: #f7fafc;
}

.choice input[type="radio"] {
    width: auto;
    margin-left: 10px;
    margin-bottom: 0;
}

.declaration-box {
    margin-top: 20px;
    background: #f8f9fa;
    padding: 20px;
    border-radius: 12px;
    text-align: right;
    display: none;
    border-right: 4px solid #667eea;
    line-height: 1.6;
}

#mapPage {
    display: none;
    height: 100vh;
    width: 100vw;
    flex-direction: row;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
}

#map {
    width: 65%;
    height: 100vh;
}

.sidebar {
    width: 35%;
    background: #fff;
    padding: 30px;
    overflow-y: auto;
    box-shadow: -2px 0 10px rgba(0,0,0,0.1);
}

.sidebar h3 {
    color: #4a5568;
    margin-bottom: 20px;
    font-size: 20px;
}

.sidebar label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #2d3748;
}

#passengerPage, #driverPage, #mapPage {
    display: none;
}

.file-input-wrapper {
    position: relative;
    margin-bottom: 15px;
}

.file-input-wrapper input[type="file"] {
    opacity: 0;
    position: absolute;
    z-index: -1;
}

.file-input-label {
    display: block;
    padding: 15px;
    background: #f8f9fa;
    border: 2px dashed #cbd5e0;
    border-radius: 12px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.file-input-label:hover {
    border-color: #667eea;
    background: #edf2f7;
}

.success-message {
    background: #c6f6d5;
    color: #22543d;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 15px;
    display: none;
}

.error-message {
    background: #fed7d7;
    color: #742a2a;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 15px;
    display: none;
}

.driver-card {
    background: white;
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border: 2px solid transparent;
    cursor: pointer;
    transition: all 0.3s ease;
}

.driver-card:hover {
    border-color: #667eea;
    transform: translateY(-2px);
}

.driver-card.selected {
    border-color: #48bb78;
    background: #f0fff4;
}

.driver-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.driver-name {
    font-weight: 600;
    color: #2d3748;
    font-size: 16px;
}

.driver-distance {
    background: #667eea;
    color: white;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 12px;
}

.car-info {
    color: #718096;
    font-size: 14px;
    margin-bottom: 10px;
}

.driver-actions {
    display: flex;
    gap: 10px;
}

.action-btn {
    flex: 1;
    padding: 8px 12px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.2s ease;
}

.call-btn {
    background: #48bb78;
    color: white;
}

.call-btn:hover {
    background: #38a169;
}

.chat-btn {
    background: #4299e1;
    color: white;
}

.chat-btn:hover {
    background: #3182ce;
}

.select-btn {
    background: #667eea;
    color: white;
}

.select-btn:hover {
    background: #5a67d8;
}

.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    border-right: 4px solid #667eea;
    z-index: 1000;
    max-width: 350px;
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.notification-title {
    font-weight: 600;
    color: #2d3748;
    margin-bottom: 10px;
}

.notification-content {
    color: #4a5568;
    margin-bottom: 15px;
    line-height: 1.5;
}

.notification-actions {
    display: flex;
    gap: 10px;
}

.accept-btn {
    background: #48bb78;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
}

.reject-btn {
    background: #e53e3e;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
}

.chat-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 300px;
    height: 400px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    display: none;
    flex-direction: column;
    z-index: 1000;
}

.chat-header {
    background: #667eea;
    color: white;
    padding: 15px;
    border-radius: 12px 12px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.chat-messages {
    flex: 1;
    padding: 15px;
    overflow-y: auto;
    max-height: 250px;
}

.chat-input-container {
    padding: 15px;
    border-top: 1px solid #e2e8f0;
    display: flex;
    gap: 10px;
}

.chat-input {
    flex: 1;
    padding: 8px 12px;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    margin: 0;
}

.send-btn {
    background: #667eea;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    margin: 0;
    width: auto;
}

.message {
    margin-bottom: 10px;
    padding: 8px 12px;
    border-radius: 8px;
    max-width: 80%;
}

.message.sent {
    background: #667eea;
    color: white;
    margin-left: auto;
    text-align: left;
}

.message.received {
    background: #f7fafc;
    color: #2d3748;
    margin-right: auto;
}

.trip-status {
    background: #e6fffa;
    border: 1px solid #81e6d9;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    text-align: center;
}

.trip-status.active {
    background: #f0fff4;
    border-color: #9ae6b4;
}

.distance-calculator {
    background: #f8f9fa;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
}

.distance-input {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
}

.distance-input input {
    flex: 1;
    margin: 0;
}

.price-display {
    background: #667eea;
    color: white;
    padding: 10px;
    border-radius: 8px;
    text-align: center;
    font-weight: 600;
    font-size: 18px;
}

.driver-popup {
    background: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    min-width: 200px;
}

.driver-popup h4 {
    margin: 0 0 10px 0;
    color: #2d3748;
    font-size: 16px;
}

.driver-popup p {
    margin: 5px 0;
    color: #4a5568;
    font-size: 14px;
}

/* New styles for cancel button */
.cancel-btn {
    background: #e53e3e;
    color: white;
}

.cancel-btn:hover {
    background: #c53030;
}

/* Map layers control styles */
.leaflet-control-layers {
    font-family: 'Cairo', sans-serif;
    direction: rtl;
    text-align: right;
}

/* ID verification preview */
.id-preview {
    max-width: 100%;
    border-radius: 8px;
    margin-top: 10px;
    border: 2px solid #e2e8f0;
}

.id-verification-message {
    margin-top: 10px;
    padding: 8px;
    border-radius: 8px;
    font-size: 14px;
    display: none;
}

.id-verification-message.valid {
    background: #c6f6d5;
    color: #22543d;
}

.id-verification-message.invalid {
    background: #fed7d7;
    color: #742a2a;
}

/* Trip control buttons */
.trip-control-buttons {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

.pickup-btn {
    background: #4299e1;
    color: white;
    flex: 1;
}

.pickup-btn:hover {
    background: #3182ce;
}

.end-trip-btn {
    background: #48bb78;
    color: white;
    flex: 1;
}

.end-trip-btn:hover {
    background: #38a169;
}

.trip-info {
    background: #edf2f7;
    border-radius: 8px;
    padding: 15px;
    margin-top: 15px;
    text-align: center;
}

.trip-info h4 {
    margin-top: 0;
    color: #2d3748;
}

.trip-info p {
    margin: 5px 0;
    color: #4a5568;
}

.trip-info .price {
    font-size: 24px;
    font-weight: 600;
    color: #2d3748;
    margin: 10px 0;
}

.passenger-info {
    background: #edf2f7;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
}

.passenger-info h4 {
    margin-top: 0;
    color: #2d3748;
}

.passenger-actions {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}

@media (max-width: 768px) {
    #mapPage {
        flex-direction: column;
    }

    #map {
        width: 100%;
        height: 60vh;
    }

    .sidebar {
        width: 100%;
        height: 40vh;
        padding: 20px;
    }

    .box {
        margin: 10px;
        padding: 20px;
    }

    .chat-container {
        width: 90%;
        right: 5%;
        left: 5%;
    }

    .notification {
        right: 10px;
        left: 10px;
        max-width: none;
    }
}
</style>
<script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js"></script>
</head>
<body>
<!-- ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div class="box" id="loginPage">
    <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ GRASIAS</h2>
    <div class="choice">
        <label>
            <input type="radio" name="role" value="sayeq">
            <span>ğŸš— Ø³Ø§Ø¦Ù‚</span>
        </label>
        <label>
            <input type="radio" name="role" value="rakib">
            <span>ğŸ§â€â™€ï¸ Ø±Ø§ÙƒØ¨</span>
        </label>
    </div>
    <button onclick="signInWithGoogle()">ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Google</button>
</div>

<!-- ØµÙØ­Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±Ø§ÙƒØ¨ -->
<div class="box" id="passengerPage">
    <h2>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±Ø§ÙƒØ¨</h2>
    <div class="success-message" id="passengerSuccess"></div>
    <div class="error-message" id="passengerError"></div>
    <input type="text" id="passengerName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" required>
    <input type="tel" id="passengerPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ù…Ø«Ø§Ù„: 0612345678)" required>
    <div class="file-input-wrapper">
        <input type="file" id="passengerIdCard" accept="image/*" onchange="previewAndVerifyID(this, 'passengerIdPreview', 'passengerIdVerification')" />
        <label for="passengerIdCard" class="file-input-label">
            ğŸ“„ Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù‡ÙˆÙŠØ©
        </label>
    </div>
    <img id="passengerIdPreview" class="id-preview" style="display: none;">
    <div id="passengerIdVerification" class="id-verification-message"></div>
    <button onclick="submitPassengerInfo()">Ù…ØªØ§Ø¨Ø¹Ø© â¡ï¸</button>
</div>

<!-- ØµÙØ­Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ -->
<div class="box" id="driverPage">
    <h2>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚</h2>
    <div class="success-message" id="driverSuccess"></div>
    <div class="error-message" id="driverError"></div>
    <input type="text" id="driverName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" required>
    <input type="tel" id="driverPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ù…Ø«Ø§Ù„: 0612345678)" required>
    <input type="text" id="carType" placeholder="Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø© (Ù…Ø«Ø§Ù„: ØªÙˆÙŠÙˆØªØ§ ÙƒÙˆØ±ÙˆÙ„Ø§)" required>
    <input type="text" id="carColor" placeholder="Ù„ÙˆÙ† Ø§Ù„Ø³ÙŠØ§Ø±Ø©" required>
    <input type="text" id="plateNumber" placeholder="Ø±Ù‚Ù… Ù„ÙˆØ­Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©" required>
    <div class="file-input-wrapper">
        <input type="file" id="driverId" accept="image/*" onchange="previewAndVerifyID(this, 'driverIdPreview', 'driverIdVerification')" required>
        <label for="driverId" class="file-input-label">
            ğŸ“„ Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù‡ÙˆÙŠØ©
        </label>
    </div>
    <img id="driverIdPreview" class="id-preview" style="display: none;">
    <div id="driverIdVerification" class="id-verification-message"></div>
    
    <div class="file-input-wrapper">
        <input type="file" id="carCheck" accept="image/*" onchange="previewAndVerifyID(this, 'carCheckPreview', 'carCheckVerification')" required>
        <label for="carCheck" class="file-input-label">
            ğŸ”§ Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø§Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„ØªÙ‚Ù†ÙŠ
        </label>
    </div>
    <img id="carCheckPreview" class="id-preview" style="display: none;">
    <div id="carCheckVerification" class="id-verification-message"></div>
    
    <button onclick="showDeclaration()">ğŸ“œ Ø¹Ø±Ø¶ Ø§Ù„ØªØ¹Ù‡Ø¯</button>
    <div class="declaration-box" id="declarationBox"></div>
    <button onclick="startDriverMap()">Ù…ØªØ§Ø¨Ø¹Ø© â¡ï¸</button>
</div>

<!-- ØµÙØ­Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© -->
<div id="mapPage">
    <div id="map"></div>
    <div class="sidebar">
        <div id="tripStatus" class="trip-status" style="display: none;">
            <div id="tripStatusText"></div>
            <button id="cancelTripBtn" onclick="cancelTrip()" class="cancel-btn" style="display: none; margin-top: 10px;">âŒ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©</button>
        </div>
        <h3 id="sidebarTitle">ğŸš— ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø­Ù„Ø©</h3>

        <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø§ÙƒØ¨ -->
        <div id="passengerContent">
            <div id="nearbyDrivers">
                <h4>Ø§Ù„Ø³Ø§Ø¦Ù‚ÙˆÙ† Ø§Ù„Ù‚Ø±ÙŠØ¨ÙˆÙ†:</h4>
                <div id="driversList"></div>
            </div>
        </div>

        <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø³Ø§Ø¦Ù‚ -->
        <div id="driverContent" style="display: none;">
            <label>Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚:</label>
            <select id="driverStatus" onchange="updateDriverStatus()">
                <option value="available">Ù…ØªØ§Ø­</option>
                <option value="busy">Ù…Ø´ØºÙˆÙ„</option>
                <option value="offline">ØºÙŠØ± Ù…ØªØµÙ„</option>
            </select>

            <label>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯ Ø§Ù„Ù…ØªØ§Ø­Ø©:</label>
            <input type="number" id="availableSeats" min="1" max="8" value="4">

            <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚:</label>
            <textarea id="driverNotes" placeholder="Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø±ÙƒØ§Ø¨..." style="height: 60px;"></textarea>

            <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±Ø§ÙƒØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ -->
            <div id="currentPassengerInfo" class="passenger-info" style="display: none;">
                <h4>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±Ø§ÙƒØ¨</h4>
                <div id="passengerDetails"></div>
                <div class="passenger-actions">
                    <button onclick="startChat(activeTrip.passengerId, activeTrip.passengerName)" class="chat-btn">ğŸ’¬ Ø¯Ø±Ø¯Ø´Ø©</button>
                    <button onclick="callPassenger()" class="call-btn">ğŸ“ Ø§ØªØµØ§Ù„</button>
                </div>
            </div>

            <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø±Ø­Ù„Ø© -->
            <div id="tripControls" class="trip-control-buttons" style="display: none;">
                <button id="pickupBtn" onclick="pickupPassenger()" class="pickup-btn">ğŸš• ØªÙ… ØªØ±ÙƒÙŠØ¨ Ø§Ù„Ø±Ø§ÙƒØ¨</button>
                <button id="endTripBtn" onclick="endTrip()" class="end-trip-btn" disabled>ğŸ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©</button>
            </div>

            <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø© ÙˆØ§Ù„Ø³Ø¹Ø± -->
            <div id="tripInfo" class="trip-info" style="display: none;">
                <h4>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø©</h4>
                <p>Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…Ù‚Ø·ÙˆØ¹Ø©: <span id="tripDistance">0</span> ÙƒÙ…</p>
                <div class="price">Ø§Ù„Ø³Ø¹Ø±: <span id="tripPrice">0</span> Ø¯ÙŠÙ†Ø§Ø±</div>
            </div>
        </div>

        <button onclick="activateRide()" id="activateBtn">ğŸš— ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø±Ø­Ù„Ø©</button>
        <button onclick="logout()" style="background: #e53e3e; margin-top: 10px;">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© -->
<div id="chatContainer" class="chat-container">
    <div class="chat-header">
        <span id="chatTitle">Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</span>
        <button onclick="closeChat()" style="background: none; border: none; color: white; cursor: pointer; padding: 0; margin: 0; width: auto;">âœ•</button>
    </div>
    <div id="chatMessages" class="chat-messages"></div>
    <div class="chat-input-container">
        <input type="text" id="chatInput" class="chat-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ...">
        <button onclick="sendMessage()" class="send-btn">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>
</div>

<!-- ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø§Øª Firebase -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, set, get, child, onValue, push, remove, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAekz29R9IwY1pygd4Mic5AX8XZ7A7Z4Fs",
        authDomain: "grasias-d7830.firebaseapp.com",
        databaseURL: "https://grasias-d7830-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "grasias-d7830",
        storageBucket: "grasias-d7830.appspot.com",
        messagingSenderId: "134413476604",
        appId: "1:134413476604:web:ab1acfa69c025218cbad79",
        measurementId: "G-6QBYM41CJ1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // Ø¬Ø¹Ù„ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ÙˆØ§Ù„Ø¯ÙˆØ§Ù„ Ù…ØªØ§Ø­Ø© Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹
    window.currentUser = null;
    window.currentRole = null;
    window.db = db;
    window.auth = auth;
    window.ref = ref;
    window.set = set;
    window.get = get;
    window.update = update;
    window.push = push;
    window.onValue = onValue;
    window.remove = remove;

    window.signInWithGoogle = () => {
        const roleInput = document.querySelector('input[name="role"]:checked');
        if (!roleInput) {
            alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¯ÙˆØ± Ù‚Ø¨Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
            return;
        }

        window.currentRole = roleInput.value;

        signInWithPopup(auth, provider)
            .then((result) => {
                const user = result.user;
                window.currentUser = user;

                const userRef = ref(db, `users/${user.uid}`);
                get(userRef).then((snapshot) => {
                    if (snapshot.exists()) {
                        const userData = snapshot.val();
                        window.currentRole = userData.role;
                        showPage("mapPage");
                        loadMap(user.displayName);
                        startLocationTracking();
                    } else {
                        set(userRef, {
                            name: user.displayName,
                            email: user.email,
                            role: window.currentRole,
                            createdAt: new Date().toISOString()
                        });

                        if (window.currentRole === "rakib") {
                            showPage("passengerPage");
                        } else {
                            showPage("driverPage");
                        }
                    }
                });
            })
            .catch((error) => {
                console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:", error);
                alert("ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: " + error.message);
            });
    };
</script>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
<script>
    let currentMap = null;
    let currentMarker = null;
    let driversMarkers = [];
    let passengersMarkers = [];
    let currentLocation = null;
    let selectedDriver = null;
    let currentTrip = null;
    let routeControl = null;
    let currentChatPartner = null;
    let mapLayers = {};
    let activeTrip = null;
    let tripStartLocation = null;
    let tripInProgress = false;
    let tripDistance = 0;
    let tripStartTime = null;
    let locationHistory = [];
    let watchPositionId = null;

    // Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ù…Ø®ØµØµØ© Ù„Ù„Ø®Ø±ÙŠØ·Ø©
    const driverIcon = L.divIcon({
        html: 'ğŸš—',
        iconSize: [30, 30],
        className: 'custom-div-icon'
    });

    const passengerIcon = L.divIcon({
        html: 'ğŸ§â€â™€ï¸',
        iconSize: [30, 30],
        className: 'custom-div-icon'
    });

    function showPage(id) {
        ["loginPage", "passengerPage", "driverPage", "mapPage"].forEach(p => {
            document.getElementById(p).style.display = "none";
        });
        document.getElementById(id).style.display = id === "mapPage" ? "flex" : "block";
    }

    function showMessage(type, message, pagePrefix = '') {
        const successEl = document.getElementById(pagePrefix + 'Success');
        const errorEl = document.getElementById(pagePrefix + 'Error');

        if (type === 'success') {
            successEl.textContent = message;
            successEl.style.display = 'block';
            errorEl.style.display = 'none';
        } else {
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            successEl.style.display = 'none';
        }

        setTimeout(() => {
            successEl.style.display = 'none';
            errorEl.style.display = 'none';
        }, 5000);
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙˆØ±Ø© Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù‡ÙˆÙŠØ©
    function previewAndVerifyID(input, previewId, verificationId) {
        const preview = document.getElementById(previewId);
        const verification = document.getElementById(verificationId);
        
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.style.display = 'block';
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙˆØ±Ø© (Ù…Ø­Ø§ÙƒØ§Ø© Ù„Ù„ØªØ­Ù‚Ù‚)
                verifyIDImage(e.target.result, verification);
            };
            
            reader.readAsDataURL(input.files[0]);
        }
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙˆØ±Ø© Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù‡ÙˆÙŠØ© (Ù…Ø­Ø§ÙƒØ§Ø©)
    function verifyIDImage(imageData, verificationElement) {
        // Ù…Ø­Ø§ÙƒØ§Ø© Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­Ù‚Ù‚ - ÙÙŠ Ø§Ù„ÙˆØ§Ù‚Ø¹ ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø¯Ù…Ø© AI Ù„Ù„ØªØ­Ù‚Ù‚
        setTimeout(() => {
            // ØªØ­Ù‚Ù‚ Ø¨Ø³ÙŠØ· Ù…Ù† Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø©
            const img = new Image();
            img.src = imageData;
            
            img.onload = function() {
                if (img.width < 200 || img.height < 200) {
                    verificationElement.textContent = "âš ï¸ Ø§Ù„ØµÙˆØ±Ø© ØµØºÙŠØ±Ø© Ø¬Ø¯Ù‹Ø§. ÙŠØ±Ø¬Ù‰ ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© Ø£ÙˆØ¶Ø­.";
                    verificationElement.className = "id-verification-message invalid";
                } else {
                    // ÙØ­Øµ Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù„Ù„ØªÙˆØ¶ÙŠØ­ ÙÙ‚Ø· (90% ÙØ±ØµØ© Ù„Ù„Ù‚Ø¨ÙˆÙ„)
                    const isValid = Math.random() > 0.1;
                    
                    if (isValid) {
                        verificationElement.textContent = "âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­";
                        verificationElement.className = "id-verification-message valid";
                    } else {
                        verificationElement.textContent = "âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø¨Ø·Ø§Ù‚Ø© Ù‡ÙˆÙŠØ© ÙÙŠ Ø§Ù„ØµÙˆØ±Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.";
                        verificationElement.className = "id-verification-message invalid";
                    }
                }
                verificationElement.style.display = "block";
            };
        }, 1000);
    }

    // Ø­Ø³Ø§Ø¨ Ø«Ù…Ù† Ø§Ù„Ù…Ø³Ø§ÙØ©
    function calculatePrice(distance) {
        if (!distance || distance <= 0) {
            return 0;
        }

        let totalPrice = 0;

        if (distance <= 20) {
            // Ù…Ù† 1 Ø¥Ù„Ù‰ 20 ÙƒÙ…: 10 Ø¯ÙŠÙ†Ø§Ø± Ù„Ù„ÙƒÙŠÙ„Ùˆ
            totalPrice = distance * 10;
        } else if (distance <= 50) {
            // Ù…Ù† 1 Ø¥Ù„Ù‰ 20: 10 Ø¯ÙŠÙ†Ø§Ø± Ù„Ù„ÙƒÙŠÙ„Ùˆ
            // Ù…Ù† 20 Ø¥Ù„Ù‰ 50: 5 Ø¯ÙŠÙ†Ø§Ø± Ù„Ù„ÙƒÙŠÙ„Ùˆ
            totalPrice = (20 * 10) + ((distance - 20) * 5);
        } else {
            // Ù…Ù† 1 Ø¥Ù„Ù‰ 20: 10 Ø¯ÙŠÙ†Ø§Ø± Ù„Ù„ÙƒÙŠÙ„Ùˆ
            // Ù…Ù† 20 Ø¥Ù„Ù‰ 50: 5 Ø¯ÙŠÙ†Ø§Ø± Ù„Ù„ÙƒÙŠÙ„Ùˆ
            // Ù…Ù† 50 ÙÙ…Ø§ ÙÙˆÙ‚: 2 Ø¯ÙŠÙ†Ø§Ø± Ù„Ù„ÙƒÙŠÙ„Ùˆ
            totalPrice = (20 * 10) + (30 * 5) + ((distance - 50) * 2);
        }

        return Math.round(totalPrice);
    }

    function loadMap(userName) {
        if (currentMap) {
            currentMap.remove();
        }

        currentMap = L.map('map').setView([28.0339, 1.6596], 6);
        
        // Ø¥Ø¶Ø§ÙØ© Ø·Ø¨Ù‚Ø§Øª Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…Ø®ØªÙ„ÙØ©
        mapLayers = {
            "Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(currentMap),
            
            "ØµÙˆØ±Ø© Ø¬ÙˆÙŠØ©": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Â© Esri'
            }),
            
            "Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø·Ø±Ù‚": L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors, Tiles style by Humanitarian OpenStreetMap Team'
            }),
            
            "Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù†Ù‚Ù„ Ø§Ù„Ø¹Ø§Ù…": L.tileLayer('https://{s}.tile.thunderforest.com/transport/{z}/{x}/{y}.png?apikey=6170aad10dfd42a38d4d8c709a536f38', {
                attribution: 'Â© OpenStreetMap contributors, Maps Â© Thunderforest'
            })
        };
        
        // Ø¥Ø¶Ø§ÙØ© ØªØ­ÙƒÙ… Ø¨Ø·Ø¨Ù‚Ø§Øª Ø§Ù„Ø®Ø±ÙŠØ·Ø©
        L.control.layers(null, mapLayers, {position: 'topright'}).addTo(currentMap);

        // ØªØ®ØµÙŠØµ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        if (window.currentRole === 'rakib') {
            document.getElementById('passengerContent').style.display = 'block';
            document.getElementById('driverContent').style.display = 'none';
            document.getElementById('sidebarTitle').textContent = 'ğŸ§â€â™€ï¸ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚';
            document.getElementById('activateBtn').textContent = 'ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚';
        } else {
            document.getElementById('passengerContent').style.display = 'none';
            document.getElementById('driverContent').style.display = 'block';
            document.getElementById('sidebarTitle').textContent = 'ğŸš— Ù„ÙˆØ­Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚';
            document.getElementById('activateBtn').textContent = 'ğŸš— ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø©';
        }

        if (navigator.geolocation) {
            const geoOptions = {
                enableHighAccuracy: true, // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ©
                timeout: 10000, // Ù…Ù‡Ù„Ø© 10 Ø«ÙˆØ§Ù†
                maximumAge: 0 // Ø¹Ø¯Ù… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø®Ø²Ù†Ø© Ù…Ø³Ø¨Ù‚Ù‹Ø§
            };
            
            navigator.geolocation.getCurrentPosition(position => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                currentLocation = { lat, lng };

                currentMap.setView([lat, lng], 14);

                if (currentMarker) {
                    currentMap.removeLayer(currentMarker);
                }

                const icon = window.currentRole === 'rakib' ? passengerIcon : driverIcon;
                currentMarker = L.marker([lat, lng], { icon }).addTo(currentMap)
                    .bindPopup(`ğŸ“ ${userName}`)
                    .openPopup();

                // Ø¨Ø¯Ø¡ ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹
                startLocationTracking();
            }, (error) => {
                console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹:", error);
                alert("âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹.");
            }, geoOptions);
        } else {
            alert("âš ï¸ Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.");
        }
    }

    // ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø¨Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ©
    function startLocationTracking() {
        if (!window.currentUser) return;

        // Ø¥ÙŠÙ‚Ø§Ù Ø£ÙŠ ØªØªØ¨Ø¹ Ø³Ø§Ø¨Ù‚
        if (watchPositionId) {
            navigator.geolocation.clearWatch(watchPositionId);
        }

        // Ø®ÙŠØ§Ø±Ø§Øª ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ©
        const geoOptions = {
            enableHighAccuracy: true, // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ©
            timeout: 10000, // Ù…Ù‡Ù„Ø© 10 Ø«ÙˆØ§Ù†
            maximumAge: 0 // Ø¹Ø¯Ù… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø®Ø²Ù†Ø© Ù…Ø³Ø¨Ù‚Ù‹Ø§
        };

        // Ø¨Ø¯Ø¡ ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø§Ø³ØªÙ…Ø±Ø§Ø±
        watchPositionId = navigator.geolocation.watchPosition(position => {
            const newLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
                accuracy: position.coords.accuracy,
                role: window.currentRole,
                name: window.currentUser.displayName,
                timestamp: Date.now(),
                status: window.currentRole === 'sayeq' ? (document.getElementById('driverStatus')?.value || 'available') : 'active'
            };

            // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø³Ø§Ø¦Ù‚Ø§Ù‹
            if (window.currentRole === 'sayeq') {
                const driverData = JSON.parse(localStorage.getItem('driverData') || '{}');
                newLocation.phone = driverData.phone || '';
                newLocation.carType = driverData.carType || '';
                newLocation.carColor = driverData.carColor || '';
                newLocation.plateNumber = driverData.plateNumber || '';
                newLocation.availableSeats = document.getElementById('availableSeats')?.value || 4;
                newLocation.notes = document.getElementById('driverNotes')?.value || '';
            }

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ Firebase
            window.set(window.ref(window.db, `locations/${window.currentUser.uid}`), newLocation);

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø­Ù„ÙŠ
            currentLocation = { lat: newLocation.lat, lng: newLocation.lng };

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
            if (currentMarker) {
                currentMarker.setLatLng([newLocation.lat, newLocation.lng]);
            }
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø±Ø­Ù„Ø© Ø¬Ø§Ø±ÙŠØ©ØŒ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…Ù‚Ø·ÙˆØ¹Ø©
            if (tripInProgress && window.currentRole === 'sayeq') {
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¥Ù„Ù‰ Ø³Ø¬Ù„ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹
                locationHistory.push({
                    lat: newLocation.lat,
                    lng: newLocation.lng,
                    timestamp: Date.now()
                });
                
                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…Ù‚Ø·ÙˆØ¹Ø©
                updateTripDistanceTraveled();
            }
        }, 
        (error) => {
            console.error("Ø®Ø·Ø£ ÙÙŠ ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹:", error);
        }, 
        geoOptions);

        // Ù…Ø±Ø§Ù‚Ø¨Ø© Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†
        if (window.currentRole === 'rakib') {
            watchDrivers();
        } else {
            watchPassengers();
        }

        // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø§Øª
        watchTripRequests();
    }

    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…Ù‚Ø·ÙˆØ¹Ø© Ø®Ù„Ø§Ù„ Ø§Ù„Ø±Ø­Ù„Ø©
    function updateTripDistanceTraveled() {
        if (!tripInProgress || locationHistory.length < 2) return;
        
        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…ØªØªØ§Ù„ÙŠØ©
        let totalDistance = 0;
        for (let i = 1; i < locationHistory.length; i++) {
            const prevLocation = locationHistory[i-1];
            const currentLocation = locationHistory[i];
            
            const segmentDistance = calculateDistance(
                prevLocation.lat, prevLocation.lng,
                currentLocation.lat, currentLocation.lng
            );
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³Ø§ÙØ© ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…Ø¹Ù‚ÙˆÙ„Ø© (Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ù‚ÙØ²Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© Ø¨Ø³Ø¨Ø¨ Ø£Ø®Ø·Ø§Ø¡ GPS)
            if (segmentDistance < 0.5) { // Ø£Ù‚Ù„ Ù…Ù† 500 Ù…ØªØ± Ø¨ÙŠÙ† Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª
                totalDistance += segmentDistance;
            }
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³Ø§ÙØ© ÙˆØ§Ù„Ø³Ø¹Ø±
        tripDistance = totalDistance;
        document.getElementById('tripDistance').textContent = tripDistance.toFixed(2);
        
        const price = calculatePrice(tripDistance);
        document.getElementById('tripPrice').textContent = price;
        
        // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø© ÙÙŠ Firebase
        if (activeTrip && activeTrip.id) {
            window.update(window.ref(window.db, `tripRequests/${activeTrip.id}`), {
                distance: tripDistance,
                price: price
            });
        }
    }

    // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† Ù„Ù„Ø±ÙƒØ§Ø¨
    function watchDrivers() {
        const driversRef = window.ref(window.db, 'locations');
        window.onValue(driversRef, (snapshot) => {
            const locations = snapshot.val();
            updateDriversOnMap(locations);
            updateDriversList(locations);
        });
    }

    // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø±ÙƒØ§Ø¨ Ù„Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†
    function watchPassengers() {
        const passengersRef = window.ref(window.db, 'locations');
        window.onValue(passengersRef, (snapshot) => {
            const locations = snapshot.val();
            updatePassengersOnMap(locations);
        });
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
    function updateDriversOnMap(locations) {
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
        driversMarkers.forEach(marker => currentMap.removeLayer(marker));
        driversMarkers = [];

        if (!locations) return;

        Object.keys(locations).forEach(userId => {
            const location = locations[userId];
            if (location.role === 'sayeq' && location.status === 'available' && userId !== window.currentUser?.uid) {
                const marker = L.marker([location.lat, location.lng], { icon: driverIcon })
                    .addTo(currentMap);

                // Ø¥Ù†Ø´Ø§Ø¡ popup Ù…Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„ÙƒØ§Ù…Ù„Ø©
                const popupContent = `
                <div class="driver-popup">
                    <h4>ğŸš— ${location.name}</h4>
                    <p><strong>ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${location.phone || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</p>
                    <p><strong>ğŸš™ Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©:</strong> ${location.carType || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                    <p><strong>ğŸ¨ Ù„ÙˆÙ† Ø§Ù„Ø³ÙŠØ§Ø±Ø©:</strong> ${location.carColor || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                    <p><strong>ğŸ”¢ Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©:</strong> ${location.plateNumber || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</p>
                    <p><strong>ğŸ’º Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯ Ø§Ù„Ù…ØªØ§Ø­Ø©:</strong> ${location.availableSeats || 4}</p>
                    ${location.notes ? `<p><strong>ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${location.notes}</p>` : ''}
                </div>
                `;

                marker.bindPopup(popupContent);
                marker.userId = userId;
                driversMarkers.push(marker);
            }
        });
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ÙƒØ§Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
    function updatePassengersOnMap(locations) {
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
        passengersMarkers.forEach(marker => currentMap.removeLayer(marker));
        passengersMarkers = [];

        if (!locations) return;

        Object.keys(locations).forEach(userId => {
            const location = locations[userId];
            if (location.role === 'rakib' && userId !== window.currentUser?.uid) {
                const marker = L.marker([location.lat, location.lng], { icon: passengerIcon })
                    .addTo(currentMap);

                const popupContent = `
                <div class="driver-popup">
                    <h4>ğŸ§â€â™€ï¸ ${location.name}</h4>
                    <p><strong>ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹:</strong> Ø±Ø§ÙƒØ¨ ÙŠØ¨Ø­Ø« Ø¹Ù† Ø±Ø­Ù„Ø©</p>
                </div>
                `;

                marker.bindPopup(popupContent);
                marker.userId = userId;
                passengersMarkers.push(marker);
            }
        });
    }

    // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†
    function updateDriversList(locations) {
        const driversList = document.getElementById('driversList');
        if (!driversList) return;

        driversList.innerHTML = '';

        if (!locations || !currentLocation) return;

        const availableDrivers = [];

        Object.keys(locations).forEach(userId => {
            const location = locations[userId];
            if (location.role === 'sayeq' && location.status === 'available' && userId !== window.currentUser?.uid) {
                const distance = calculateDistance(currentLocation.lat, currentLocation.lng, location.lat, location.lng);
                availableDrivers.push({ ...location, userId, distance });
            }
        });

        // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©
        availableDrivers.sort((a, b) => a.distance - b.distance);

        availableDrivers.forEach(driver => {
            const driverCard = document.createElement('div');
            driverCard.className = 'driver-card';
            driverCard.innerHTML = `
            <div class="driver-info">
                <span class="driver-name">ğŸš— ${driver.name}</span>
                <span class="driver-distance">${driver.distance.toFixed(1)} ÙƒÙ…</span>
            </div>
            <div class="car-info">
                ğŸš™ ${driver.carType || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'} - ğŸ¨ ${driver.carColor || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
                <br>ğŸ’º ${driver.availableSeats || 4} Ù…Ù‚Ø§Ø¹Ø¯ Ù…ØªØ§Ø­Ø©
            </div>
            <div class="driver-actions">
                <button class="action-btn call-btn" onclick="callDriver('${driver.phone}')">ğŸ“ Ø§ØªØµØ§Ù„</button>
                <button class="action-btn chat-btn" onclick="startChat('${driver.userId}', '${driver.name}')">ğŸ’¬ Ø¯Ø±Ø¯Ø´Ø©</button>
                <button class="action-btn select-btn" onclick="selectDriver('${driver.userId}')">âœ… Ø§Ø®ØªÙŠØ§Ø±</button>
            </div>
            `;
            driversList.appendChild(driverCard);
        });

        if (availableDrivers.length === 0) {
            driversList.innerHTML = '<p style="text-align: center; color: #718096;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø§Ø¦Ù‚ÙˆÙ† Ù…ØªØ§Ø­ÙˆÙ† ÙÙŠ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</p>';
        }
    }

    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ù†Ù‚Ø·ØªÙŠÙ†
    function calculateDistance(lat1, lng1, lat2, lng2) {
        const R = 6371; // Ù†ØµÙ Ù‚Ø·Ø± Ø§Ù„Ø£Ø±Ø¶ Ø¨Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLng = (lng2 - lng1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng/2) * Math.sin(dLng/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    // Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³Ø§Ø¦Ù‚
    function callDriver(phone) {
        if (phone && phone !== 'ØºÙŠØ± Ù…ØªÙˆÙØ±') {
            window.open(`tel:${phone}`, '_self');
        } else {
            alert('Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± Ù…ØªÙˆÙØ±');
        }
    }
    
    // Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø±Ø§ÙƒØ¨
    function callPassenger() {
        if (!activeTrip) return;
        
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ø±Ø§ÙƒØ¨ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        window.get(window.ref(window.db, `users/${activeTrip.passengerId}`))
            .then((snapshot) => {
                if (snapshot.exists()) {
                    const passengerData = snapshot.val();
                    if (passengerData.phone) {
                        window.open(`tel:${passengerData.phone}`, '_self');
                    } else {
                        alert('Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ø±Ø§ÙƒØ¨ ØºÙŠØ± Ù…ØªÙˆÙØ±');
                    }
                } else {
                    alert('Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±Ø§ÙƒØ¨ ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©');
                }
            });
    }

    // Ø¨Ø¯Ø¡ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
    function startChat(userId, userName) {
        currentChatPartner = { userId, userName };
        document.getElementById('chatTitle').textContent = `Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¹ ${userName}`;
        document.getElementById('chatContainer').style.display = 'flex';
        loadChatMessages(userId);
    }

    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
    function closeChat() {
        document.getElementById('chatContainer').style.display = 'none';
        currentChatPartner = null;
    }

    // ØªØ­Ù…ÙŠÙ„ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
    function loadChatMessages(partnerId) {
        const chatId = [window.currentUser.uid, partnerId].sort().join('_');
        const messagesRef = window.ref(window.db, `chats/${chatId}/messages`);

        window.onValue(messagesRef, (snapshot) => {
            const messages = snapshot.val();
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';

            if (messages) {
                Object.keys(messages).forEach(messageId => {
                    const message = messages[messageId];
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${message.senderId === window.currentUser.uid ? 'sent' : 'received'}`;
                    messageDiv.textContent = message.text;
                    chatMessages.appendChild(messageDiv);
                });
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        });
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
    function sendMessage() {
        const chatInput = document.getElementById('chatInput');
        const messageText = chatInput.value.trim();

        if (!messageText || !currentChatPartner) return;

        const chatId = [window.currentUser.uid, currentChatPartner.userId].sort().join('_');
        const messagesRef = window.ref(window.db, `chats/${chatId}/messages`);

        window.push(messagesRef, {
            text: messageText,
            senderId: window.currentUser.uid,
            senderName: window.currentUser.displayName,
            timestamp: Date.now()
        });

        chatInput.value = '';
    }

    // Ø§Ø®ØªÙŠØ§Ø± Ø³Ø§Ø¦Ù‚
    function selectDriver(driverId) {
        selectedDriver = driverId;

        // Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø±Ø­Ù„Ø© Ù„Ù„Ø³Ø§Ø¦Ù‚
        const tripRequest = {
            passengerId: window.currentUser.uid,
            passengerName: window.currentUser.displayName,
            driverId: driverId,
            passengerLocation: currentLocation,
            status: 'pending',
            timestamp: Date.now()
        };

        window.push(window.ref(window.db, 'tripRequests'), tripRequest)
            .then((ref) => {
                const requestId = ref.key;
                showNotification('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø±Ø­Ù„Ø©', 'ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚...', 'info');
                
                // ØªØ®Ø²ÙŠÙ† Ù…Ø¹Ø±Ù Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø¥Ù„ØºØ§Ø¡ Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
                localStorage.setItem('currentTripRequestId', requestId);
            });
    }

    // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø§Øª
    function watchTripRequests() {
        const requestsRef = window.ref(window.db, 'tripRequests');
        window.onValue(requestsRef, (snapshot) => {
            const requests = snapshot.val();
            if (!requests) return;

            Object.keys(requests).forEach(requestId => {
                const request = requests[requestId];

                // Ù„Ù„Ø³Ø§Ø¦Ù‚: Ø¹Ø±Ø¶ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©
                if (window.currentRole === 'sayeq' && request.driverId === window.currentUser.uid && request.status === 'pending') {
                    showTripRequestNotification(request, requestId);
                }

                // Ù„Ù„Ø±Ø§ÙƒØ¨: Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨
                if (window.currentRole === 'rakib' && request.passengerId === window.currentUser.uid) {
                    updateTripStatus(request, requestId);
                }
                
                // Ù„Ù„Ø³Ø§Ø¦Ù‚: Ø¥Ø°Ø§ ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø©ØŒ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³Ø§Ø±
                if (window.currentRole === 'sayeq' && request.driverId === window.currentUser.uid && 
                    (request.status === 'accepted' || request.status === 'pickup' || request.status === 'inProgress')) {
                    
                    if (!activeTrip || activeTrip.id !== requestId) {
                        activeTrip = { ...request, id: requestId };
                        
                        // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±Ø§ÙƒØ¨
                        showPassengerInfo(request);
                        
                        // Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø± Ø¥Ù„Ù‰ Ø§Ù„Ø±Ø§ÙƒØ¨ Ø¥Ø°Ø§ Ù„Ù… ØªØ¨Ø¯Ø£ Ø§Ù„Ø±Ø­Ù„Ø© Ø¨Ø¹Ø¯
                        if (request.status === 'accepted') {
                            drawRoute(currentLocation, request.passengerLocation);
                            document.getElementById('tripControls').style.display = 'flex';
                            document.getElementById('pickupBtn').disabled = false;
                            document.getElementById('endTripBtn').disabled = true;
                        }
                        
                        // ØªÙ‚Ù„ÙŠÙ„ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯ Ø§Ù„Ù…ØªØ§Ø­Ø©
                        const availableSeatsElement = document.getElementById('availableSeats');
                        if (availableSeatsElement) {
                            const currentSeats = parseInt(availableSeatsElement.value) || 4;
                            if (currentSeats > 1) {
                                availableSeatsElement.value = currentSeats - 1;
                                updateDriverStatus(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                            }
                        }
                    }
                    
                    // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø±Ø­Ù„Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°ØŒ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø­Ù„Ø©
                    if (request.status === 'pickup' && !tripInProgress) {
                        // ØªÙ… ØªØ±ÙƒÙŠØ¨ Ø§Ù„Ø±Ø§ÙƒØ¨ØŒ Ø¨Ø¯Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©
                        tripInProgress = true;
                        tripStartLocation = { ...currentLocation };
                        tripStartTime = Date.now();
                        locationHistory = [{ ...currentLocation, timestamp: tripStartTime }];
                        document.getElementById('pickupBtn').disabled = true;
                        document.getElementById('endTripBtn').disabled = false;
                        document.getElementById('tripInfo').style.display = 'block';
                    }
                }
            });
        });
    }
    
    // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±Ø§ÙƒØ¨ Ù„Ù„Ø³Ø§Ø¦Ù‚
    function showPassengerInfo(request) {
        const passengerInfoDiv = document.getElementById('currentPassengerInfo');
        const passengerDetailsDiv = document.getElementById('passengerDetails');
        
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±Ø§ÙƒØ¨ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        window.get(window.ref(window.db, `users/${request.passengerId}`))
            .then((snapshot) => {
                if (snapshot.exists()) {
                    const passengerData = snapshot.val();
                    passengerDetailsDiv.innerHTML = `
                        <p><strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${request.passengerName}</p>
                        <p><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${passengerData.phone || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</p>
                    `;
                    passengerInfoDiv.style.display = 'block';
                }
            });
    }

    // ØªÙ… ØªØ±ÙƒÙŠØ¨ Ø§Ù„Ø±Ø§ÙƒØ¨
    function pickupPassenger() {
        if (!activeTrip) return;
        
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø­Ù„Ø©
        window.update(window.ref(window.db, `tripRequests/${activeTrip.id}`), {
            status: 'pickup',
            pickupTime: Date.now(),
            pickupLocation: currentLocation
        }).then(() => {
            // Ø¨Ø¯Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©
            tripInProgress = true;
            tripStartLocation = { ...currentLocation };
            tripStartTime = Date.now();
            locationHistory = [{ ...currentLocation, timestamp: tripStartTime }];
            
            // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            document.getElementById('pickupBtn').disabled = true;
            document.getElementById('endTripBtn').disabled = false;
            document.getElementById('tripInfo').style.display = 'block';
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚
            if (routeControl) {
                currentMap.removeControl(routeControl);
                routeControl = null;
            }
            
            showNotification('ØªÙ… ØªØ±ÙƒÙŠØ¨ Ø§Ù„Ø±Ø§ÙƒØ¨', 'Ø¨Ø¯Ø£ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© ÙˆØ§Ù„Ø³Ø¹Ø±', 'success');
        });
    }
    
    // Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©
    function endTrip() {
        if (!activeTrip || !tripInProgress) return;
        
        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
        const finalPrice = calculatePrice(tripDistance);
        
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø­Ù„Ø©
        window.update(window.ref(window.db, `tripRequests/${activeTrip.id}`), {
            status: 'completed',
            endTime: Date.now(),
            endLocation: currentLocation,
            distance: tripDistance,
            price: finalPrice
        }).then(() => {
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø­Ù„Ø©
            tripInProgress = false;
            
            // Ø¹Ø±Ø¶ Ù…Ù„Ø®Øµ Ø§Ù„Ø±Ø­Ù„Ø©
            showNotification('ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©', `Ø§Ù„Ù…Ø³Ø§ÙØ©: ${tripDistance.toFixed(2)} ÙƒÙ… | Ø§Ù„Ø³Ø¹Ø±: ${finalPrice} Ø¯ÙŠÙ†Ø§Ø±`, 'success');
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            document.getElementById('tripControls').style.display = 'none';
            document.getElementById('currentPassengerInfo').style.display = 'none';
            
            // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯ Ø§Ù„Ù…ØªØ§Ø­Ø©
            const availableSeatsElement = document.getElementById('availableSeats');
            if (availableSeatsElement) {
                const currentSeats = parseInt(availableSeatsElement.value) || 3;
                availableSeatsElement.value = currentSeats + 1;
                updateDriverStatus(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            }
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
            activeTrip = null;
            tripStartLocation = null;
            locationHistory = [];
        });
    }

    // Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø± Ø¨ÙŠÙ† Ù†Ù‚Ø·ØªÙŠÙ†
    function drawRoute(start, end) {
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¥Ù† ÙˆØ¬Ø¯
        if (routeControl) {
            currentMap.removeControl(routeControl);
        }
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³Ø§Ø± Ø¬Ø¯ÙŠØ¯
        routeControl = L.Routing.control({
            waypoints: [
                L.latLng(start.lat, start.lng),
                L.latLng(end.lat, end.lng)
            ],
            routeWhileDragging: false,
            showAlternatives: false,
            fitSelectedRoutes: true,
            lineOptions: {
                styles: [
                    {color: '#667eea', opacity: 0.8, weight: 6}
                ]
            },
            createMarker: function() { return null; } // Ù„Ø§ Ù†Ø±ÙŠØ¯ Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù„Ø§Ù…Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©
        }).addTo(currentMap);
    }

    // Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø± Ø·Ù„Ø¨ Ø§Ù„Ø±Ø­Ù„Ø© Ù„Ù„Ø³Ø§Ø¦Ù‚
    function showTripRequestNotification(request, requestId) {
        // ØªØ¬Ù†Ø¨ Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…ØªÙƒØ±Ø±Ø©
        if (document.querySelector(`.notification[data-request-id="${requestId}"]`)) {
            return;
        }
        
        const notification = document.createElement('div');
        notification.className = 'notification';
        notification.setAttribute('data-request-id', requestId);
        notification.innerHTML = `
        <div class="notification-title">ğŸš— Ø·Ù„Ø¨ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯</div>
        <div class="notification-content">
            Ø§Ù„Ø±Ø§ÙƒØ¨: ${request.passengerName}<br>
            Ø§Ù„Ù…Ø³Ø§ÙØ©: ${calculateDistance(currentLocation.lat, currentLocation.lng, request.passengerLocation.lat, request.passengerLocation.lng).toFixed(1)} ÙƒÙ…
        </div>
        <div class="notification-actions">
            <button class="accept-btn" onclick="acceptTrip('${requestId}')">Ù‚Ø¨ÙˆÙ„</button>
            <button class="reject-btn" onclick="rejectTrip('${requestId}')">Ø±ÙØ¶</button>
        </div>
        `;
        document.body.appendChild(notification);

        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø¹Ø¯ 30 Ø«Ø§Ù†ÙŠØ©
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 30000);
    }

    // Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø©
    function acceptTrip(requestId) {
        window.get(window.ref(window.db, `tripRequests/${requestId}`))
            .then((snapshot) => {
                if (snapshot.exists()) {
                    const request = snapshot.val();
                    
                    window.update(window.ref(window.db, `tripRequests/${requestId}`), {
                        status: 'accepted',
                        acceptedAt: Date.now()
                    });
                    
                    // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ù†Ø´Ø·Ø©
                    activeTrip = { ...request, id: requestId, status: 'accepted' };
                    
                    // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±Ø§ÙƒØ¨
                    showPassengerInfo(request);
                    
                    // Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø± Ø¥Ù„Ù‰ Ø§Ù„Ø±Ø§ÙƒØ¨
                    drawRoute(currentLocation, request.passengerLocation);
                    
                    // Ø¹Ø±Ø¶ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø±Ø­Ù„Ø©
                    document.getElementById('tripControls').style.display = 'flex';
                    document.getElementById('pickupBtn').disabled = false;
                    document.getElementById('endTripBtn').disabled = true;
                    
                    // ØªÙ‚Ù„ÙŠÙ„ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯ Ø§Ù„Ù…ØªØ§Ø­Ø©
                    const availableSeatsElement = document.getElementById('availableSeats');
                    if (availableSeatsElement) {
                        const currentSeats = parseInt(availableSeatsElement.value) || 4;
                        if (currentSeats > 1) {
                            availableSeatsElement.value = currentSeats - 1;
                            updateDriverStatus(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                        }
                    }
                }
            });

        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
        const notifications = document.querySelectorAll(`.notification[data-request-id="${requestId}"]`);
        notifications.forEach(notification => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        });

        showNotification('ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø©', 'ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø±Ø§ÙƒØ¨', 'success');
    }

    // Ø±ÙØ¶ Ø§Ù„Ø±Ø­Ù„Ø©
    function rejectTrip(requestId) {
        window.update(window.ref(window.db, `tripRequests/${requestId}`), {
            status: 'rejected',
            rejectedAt: Date.now()
        });

        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
        const notifications = document.querySelectorAll(`.notification[data-request-id="${requestId}"]`);
        notifications.forEach(notification => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        });
    }

    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø­Ù„Ø© Ù„Ù„Ø±Ø§ÙƒØ¨
    function updateTripStatus(request, requestId) {
        const statusDiv = document.getElementById('tripStatus');
        const statusText = document.getElementById('tripStatusText');
        const cancelBtn = document.getElementById('cancelTripBtn');

        if (request.status === 'pending') {
            statusDiv.style.display = 'block';
            statusText.textContent = 'â³ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚...';
            statusDiv.className = 'trip-status';
            cancelBtn.style.display = 'block';
            
            // ØªØ®Ø²ÙŠÙ† Ù…Ø¹Ø±Ù Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø¥Ù„ØºØ§Ø¡
            localStorage.setItem('currentTripRequestId', requestId);
        } else if (request.status === 'accepted') {
            statusDiv.style.display = 'block';
            statusText.textContent = 'âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø©! Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚ Ø¥Ù„ÙŠÙƒ';
            statusDiv.className = 'trip-status active';
            cancelBtn.style.display = 'block';
            
            // ØªØ®Ø²ÙŠÙ† Ù…Ø¹Ø±Ù Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø¥Ù„ØºØ§Ø¡
            localStorage.setItem('currentTripRequestId', requestId);
            
            // Ø¨Ø¯Ø¡ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚
            startChat(request.driverId, "Ø§Ù„Ø³Ø§Ø¦Ù‚");
            
            // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ù†Ø´Ø·Ø©
            activeTrip = { ...request, id: requestId };
        } else if (request.status === 'pickup') {
            statusDiv.style.display = 'block';
            statusText.textContent = 'ğŸš• Ø¨Ø¯Ø£Øª Ø§Ù„Ø±Ø­Ù„Ø©! Ø±Ø­Ù„Ø© Ø³Ø¹ÙŠØ¯Ø©';
            statusDiv.className = 'trip-status active';
            cancelBtn.style.display = 'block';
            
            // ØªØ®Ø²ÙŠÙ† Ù…Ø¹Ø±Ù Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø¥Ù„ØºØ§Ø¡
            localStorage.setItem('currentTripRequestId', requestId);
            
            // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ù†Ø´Ø·Ø©
            activeTrip = { ...request, id: requestId };
        } else if (request.status === 'completed') {
            statusDiv.style.display = 'block';
            statusText.innerHTML = `âœ… ØªÙ…Øª Ø§Ù„Ø±Ø­Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!<br>Ø§Ù„Ù…Ø³Ø§ÙØ©: ${request.distance?.toFixed(2) || 0} ÙƒÙ…<br>Ø§Ù„Ø³Ø¹Ø±: ${request.price || 0} Ø¯ÙŠÙ†Ø§Ø±`;
            statusDiv.className = 'trip-status active';
            cancelBtn.style.display = 'none';
            
            // Ù…Ø³Ø­ Ù…Ø¹Ø±Ù Ø§Ù„Ø·Ù„Ø¨
            localStorage.removeItem('currentTripRequestId');
            
            // Ù…Ø³Ø­ Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ù†Ø´Ø·Ø© Ø¨Ø¹Ø¯ 30 Ø«Ø§Ù†ÙŠØ©
            setTimeout(() => {
                statusDiv.style.display = 'none';
                activeTrip = null;
            }, 30000);
        } else if (request.status === 'rejected') {
            statusDiv.style.display = 'block';
            statusText.textContent = 'âŒ ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø±Ø­Ù„Ø©. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚ Ø¢Ø®Ø±';
            statusDiv.className = 'trip-status';
            cancelBtn.style.display = 'none';
            
            // Ù…Ø³Ø­ Ù…Ø¹Ø±Ù Ø§Ù„Ø·Ù„Ø¨
            localStorage.removeItem('currentTripRequestId');
        } else if (request.status === 'cancelled') {
            statusDiv.style.display = 'block';
            statusText.textContent = 'ğŸš« ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©';
            statusDiv.className = 'trip-status';
            cancelBtn.style.display = 'none';
            
            // Ù…Ø³Ø­ Ù…Ø¹Ø±Ù Ø§Ù„Ø·Ù„Ø¨
            localStorage.removeItem('currentTripRequestId');
        }
    }

    // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©
    function cancelTrip() {
        const requestId = localStorage.getItem('currentTripRequestId');
        if (!requestId) {
            showNotification('Ø®Ø·Ø£', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø­Ù„Ø© Ù†Ø´Ø·Ø© Ù„Ù„Ø¥Ù„ØºØ§Ø¡', 'error');
            return;
        }
        
        window.update(window.ref(window.db, `tripRequests/${requestId}`), {
            status: 'cancelled',
            cancelledAt: Date.now(),
            cancelledBy: window.currentUser.uid
        }).then(() => {
            showNotification('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©', 'ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            const statusDiv = document.getElementById('tripStatus');
            const statusText = document.getElementById('tripStatusText');
            const cancelBtn = document.getElementById('cancelTripBtn');
            
            statusDiv.style.display = 'block';
            statusText.textContent = 'ğŸš« ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©';
            statusDiv.className = 'trip-status';
            cancelBtn.style.display = 'none';
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§Ø± Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø³Ø§Ø¦Ù‚
            if (window.currentRole === 'sayeq' && routeControl) {
                currentMap.removeControl(routeControl);
                routeControl = null;
                
                // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯ Ø§Ù„Ù…ØªØ§Ø­Ø©
                if (activeTrip) {
                    const availableSeatsElement = document.getElementById('availableSeats');
                    if (availableSeatsElement) {
                        const currentSeats = parseInt(availableSeatsElement.value) || 3;
                        availableSeatsElement.value = currentSeats + 1;
                        updateDriverStatus(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    }
                }
                
                // Ø¥Ø®ÙØ§Ø¡ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±Ø§ÙƒØ¨ ÙˆØ£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ…
                document.getElementById('currentPassengerInfo').style.display = 'none';
                document.getElementById('tripControls').style.display = 'none';
                document.getElementById('tripInfo').style.display = 'none';
            }
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
            tripInProgress = false;
            activeTrip = null;
            tripStartLocation = null;
            locationHistory = [];
            
            // Ù…Ø³Ø­ Ù…Ø¹Ø±Ù Ø§Ù„Ø·Ù„Ø¨
            localStorage.removeItem('currentTripRequestId');
        });
    }

    // Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø±
    function showNotification(title, content, type) {
        const notification = document.createElement('div');
        notification.className = 'notification';
        notification.innerHTML = `
        <div class="notification-title">${title}</div>
        <div class="notification-content">${content}</div>
        `;
        document.body.appendChild(notification);

        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 5000);
    }

    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚
    function updateDriverStatus() {
        const status = document.getElementById('driverStatus').value;
        const availableSeats = document.getElementById('availableSeats').value;
        const notes = document.getElementById('driverNotes').value;
        
        if (window.currentUser && currentLocation) {
            window.update(window.ref(window.db, `locations/${window.currentUser.uid}`), {
                status: status,
                availableSeats: availableSeats,
                notes: notes
            });
        }
    }

    // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø±Ø­Ù„Ø©
    function activateRide() {
        if (window.currentRole === 'rakib') {
            // Ù„Ù„Ø±Ø§ÙƒØ¨: Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚
            showMessage('success', 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† Ø§Ù„Ù…ØªØ§Ø­ÙŠÙ†...');
        } else {
            // Ù„Ù„Ø³Ø§Ø¦Ù‚: ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø©
            const status = document.getElementById('driverStatus').value;
            if (status === 'available') {
                showMessage('success', 'ØªÙ… ØªÙØ¹ÙŠÙ„ Ø®Ø¯Ù…Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¨Ù†Ø¬Ø§Ø­!');
            } else {
                showMessage('error', 'ÙŠØ¬Ø¨ ØªØºÙŠÙŠØ± Ø­Ø§Ù„ØªÙƒ Ø¥Ù„Ù‰ "Ù…ØªØ§Ø­" Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø©');
            }
        }
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±Ø§ÙƒØ¨
    function submitPassengerInfo() {
        const name = document.getElementById('passengerName').value;
        const phone = document.getElementById('passengerPhone').value;
        const idCard = document.getElementById('passengerIdCard').files[0];
        const idVerification = document.getElementById('passengerIdVerification');

        if (!name || !phone || !idCard) {
            showMessage('error', 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'passenger');
            return;
        }
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù‡ÙˆÙŠØ©
        if (idVerification.className.includes('invalid')) {
            showMessage('error', 'ÙŠØ±Ø¬Ù‰ ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© ØµØ§Ù„Ø­Ø© Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù‡ÙˆÙŠØ©', 'passenger');
            return;
        }

        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹
        localStorage.setItem('passengerData', JSON.stringify({ name, phone }));

        // Ø­ÙØ¸ ÙÙŠ Firebase
        window.update(window.ref(window.db, `users/${window.currentUser.uid}`), {
            name: name,
            phone: phone,
            profileComplete: true
        }).then(() => {
            showMessage('success', 'ØªÙ… Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­!', 'passenger');
            setTimeout(() => {
                showPage("mapPage");
                loadMap(name);
                startLocationTracking();
            }, 2000);
        });
    }

    // Ø¨Ø¯Ø¡ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚
    function startDriverMap() {
        const name = document.getElementById('driverName').value;
        const phone = document.getElementById('driverPhone').value;
        const carType = document.getElementById('carType').value;
        const carColor = document.getElementById('carColor').value;
        const plateNumber = document.getElementById('plateNumber').value;
        const driverIdVerification = document.getElementById('driverIdVerification');
        const carCheckVerification = document.getElementById('carCheckVerification');

        if (!name || !phone || !carType || !carColor || !plateNumber) {
            showMessage('error', 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'driver');
            return;
        }
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª
        if (driverIdVerification.className.includes('invalid')) {
            showMessage('error', 'ÙŠØ±Ø¬Ù‰ ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© ØµØ§Ù„Ø­Ø© Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù‡ÙˆÙŠØ©', 'driver');
            return;
        }
        
        if (carCheckVerification.className.includes('invalid')) {
            showMessage('error', 'ÙŠØ±Ø¬Ù‰ ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© ØµØ§Ù„Ø­Ø© Ù„Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„ØªÙ‚Ù†ÙŠ', 'driver');
            return;
        }

        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹
        localStorage.setItem('driverData', JSON.stringify({
            name, phone, carType, carColor, plateNumber
        }));

        // Ø­ÙØ¸ ÙÙŠ Firebase
        window.update(window.ref(window.db, `users/${window.currentUser.uid}`), {
            name: name,
            phone: phone,
            carType: carType,
            carColor: carColor,
            plateNumber: plateNumber,
            profileComplete: true
        }).then(() => {
            showMessage('success', 'ØªÙ… Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­!', 'driver');
            setTimeout(() => {
                showPage("mapPage");
                loadMap(name);
                startLocationTracking();
            }, 2000);
        });
    }

    // Ø¹Ø±Ø¶ Ø§Ù„ØªØ¹Ù‡Ø¯
    function showDeclaration() {
        const declarationBox = document.getElementById('declarationBox');
        declarationBox.innerHTML = `
        <h4>ØªØ¹Ù‡Ø¯ Ø§Ù„Ø³Ø§Ø¦Ù‚</h4>
        <p>Ø£ØªØ¹Ù‡Ø¯ Ø¨Ø£Ù†:</p>
        <ul style="text-align: right;">
            <li>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© ØµØ­ÙŠØ­Ø© ÙˆØ¯Ù‚ÙŠÙ‚Ø©</li>
            <li>Ø³ÙŠØ§Ø±ØªÙŠ ÙÙŠ Ø­Ø§Ù„Ø© Ø¬ÙŠØ¯Ø© ÙˆØµØ§Ù„Ø­Ø© Ù„Ù„Ù‚ÙŠØ§Ø¯Ø©</li>
            <li>Ø£Ø­Ù…Ù„ Ø±Ø®ØµØ© Ù‚ÙŠØ§Ø¯Ø© Ø³Ø§Ø±ÙŠØ© Ø§Ù„Ù…ÙØ¹ÙˆÙ„</li>
            <li>Ø³Ø£Ù‚ÙˆÙ… Ø¨ØªÙˆÙÙŠØ± Ø®Ø¯Ù…Ø© Ø¢Ù…Ù†Ø© ÙˆÙ…Ù‡Ø°Ø¨Ø© Ù„Ù„Ø±ÙƒØ§Ø¨</li>
            <li>Ø³Ø£Ø­ØªØ±Ù… Ù‚ÙˆØ§Ù†ÙŠÙ† Ø§Ù„Ù…Ø±ÙˆØ± ÙˆØ£Ù†Ø¸Ù…Ø© Ø§Ù„Ø³Ù„Ø§Ù…Ø©</li>
        </ul>
        `;
        declarationBox.style.display = 'block';
    }

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
    function logout() {
        if (window.currentUser) {
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Firebase
            window.set(window.ref(window.db, `locations/${window.currentUser.uid}`), null);
        }

        window.currentUser = null;
        window.currentRole = null;
        localStorage.clear();
        showPage('loginPage');
    }

    // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter
    document.addEventListener('DOMContentLoaded', function() {
        const chatInput = document.getElementById('chatInput');
        if (chatInput) {
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        }
    });
</script>
</body>
</html>
