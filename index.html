<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GRASIAS</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
* {
    box-sizing: border-box;
}

body {
    font-family: 'Cairo', sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    margin: 0;
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    direction: rtl;
    padding: 20px;
}

.box {
    background: white;
    padding: 30px 25px;
    border-radius: 20px;
    box-shadow: 0 15px 50px rgba(0,0,0,0.2);
    width: 100%;
    max-width: 400px;
    text-align: center;
    animation: fadeIn 0.6s ease-in-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

h2 {
    margin-bottom: 25px;
    color: #4a5568;
    font-weight: 600;
    font-size: 24px;
}

input, button, textarea, select {
    width: 100%;
    padding: 15px;
    border-radius: 12px;
    margin-bottom: 15px;
    font-size: 16px;
    border: 2px solid #e2e8f0;
    transition: all 0.3s ease;
    font-family: 'Cairo', sans-serif;
}

input:focus, textarea:focus, select:focus {
    border-color: #667eea;
    outline: none;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

button {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    cursor: pointer;
    font-weight: 600;
    transition: transform 0.2s ease;
}

button:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
}

button:active {
    transform: translateY(0);
}

.choice {
    text-align: right;
    margin: 25px 0;
}

.choice label {
    display: flex;
    align-items: center;
    margin-bottom: 12px;
    font-size: 16px;
    cursor: pointer;
    padding: 10px;
    border-radius: 8px;
    transition: background-color 0.2s ease;
}

.choice label:hover {
    background-color: #f7fafc;
}

.choice input[type="radio"] {
    width: auto;
    margin-left: 10px;
    margin-bottom: 0;
}

.declaration-box {
    margin-top: 20px;
    background: #f8f9fa;
    padding: 20px;
    border-radius: 12px;
    text-align: right;
    display: none;
    border-right: 4px solid #667eea;
    line-height: 1.6;
}

#mapPage {
    display: none;
    height: 100vh;
    width: 100vw;
    flex-direction: row;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
}

#map {
    width: 65%;
    height: 100vh;
}

.sidebar {
    width: 35%;
    background: #fff;
    padding: 30px;
    overflow-y: auto;
    box-shadow: -2px 0 10px rgba(0,0,0,0.1);
}

.sidebar h3 {
    color: #4a5568;
    margin-bottom: 20px;
    font-size: 20px;
}

.sidebar label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #2d3748;
}

#passengerPage, #driverPage, #mapPage {
    display: none;
}

.file-input-wrapper {
    position: relative;
    margin-bottom: 15px;
}

.file-input-wrapper input[type="file"] {
    opacity: 0;
    position: absolute;
    z-index: -1;
}

.file-input-label {
    display: block;
    padding: 15px;
    background: #f8f9fa;
    border: 2px dashed #cbd5e0;
    border-radius: 12px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.file-input-label:hover {
    border-color: #667eea;
    background: #edf2f7;
}

.success-message {
    background: #c6f6d5;
    color: #22543d;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 15px;
    display: none;
}

.error-message {
    background: #fed7d7;
    color: #742a2a;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 15px;
    display: none;
}

.driver-card {
    background: white;
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border: 2px solid transparent;
    cursor: pointer;
    transition: all 0.3s ease;
}

.driver-card:hover {
    border-color: #667eea;
    transform: translateY(-2px);
}

.driver-card.selected {
    border-color: #48bb78;
    background: #f0fff4;
}

.driver-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.driver-name {
    font-weight: 600;
    color: #2d3748;
    font-size: 16px;
}

.driver-distance {
    background: #667eea;
    color: white;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 12px;
}

.car-info {
    color: #718096;
    font-size: 14px;
    margin-bottom: 10px;
}

.driver-actions {
    display: flex;
    gap: 10px;
}

.action-btn {
    flex: 1;
    padding: 8px 12px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.2s ease;
}

.call-btn {
    background: #48bb78;
    color: white;
}

.call-btn:hover {
    background: #38a169;
}

.chat-btn {
    background: #4299e1;
    color: white;
}

.chat-btn:hover {
    background: #3182ce;
}

.select-btn {
    background: #667eea;
    color: white;
}

.select-btn:hover {
    background: #5a67d8;
}

.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    border-right: 4px solid #667eea;
    z-index: 1000;
    max-width: 350px;
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.notification-title {
    font-weight: 600;
    color: #2d3748;
    margin-bottom: 10px;
}

.notification-content {
    color: #4a5568;
    margin-bottom: 15px;
    line-height: 1.5;
}

.notification-actions {
    display: flex;
    gap: 10px;
}

.accept-btn {
    background: #48bb78;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
}

.reject-btn {
    background: #e53e3e;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
}

.chat-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 300px;
    height: 400px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    display: none;
    flex-direction: column;
    z-index: 1000;
}

.chat-header {
    background: #667eea;
    color: white;
    padding: 15px;
    border-radius: 12px 12px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.chat-messages {
    flex: 1;
    padding: 15px;
    overflow-y: auto;
    max-height: 250px;
}

.chat-input-container {
    padding: 15px;
    border-top: 1px solid #e2e8f0;
    display: flex;
    gap: 10px;
}

.chat-input {
    flex: 1;
    padding: 8px 12px;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    margin: 0;
}

.send-btn {
    background: #667eea;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    margin: 0;
    width: auto;
}

.message {
    margin-bottom: 10px;
    padding: 8px 12px;
    border-radius: 8px;
    max-width: 80%;
}

.message.sent {
    background: #667eea;
    color: white;
    margin-left: auto;
    text-align: left;
}

.message.received {
    background: #f7fafc;
    color: #2d3748;
    margin-right: auto;
}

.trip-status {
    background: #e6fffa;
    border: 1px solid #81e6d9;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    text-align: center;
}

.trip-status.active {
    background: #f0fff4;
    border-color: #9ae6b4;
}

.distance-calculator {
    background: #f8f9fa;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
}

.distance-input {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
}

.distance-input input {
    flex: 1;
    margin: 0;
}

.price-display {
    background: #667eea;
    color: white;
    padding: 10px;
    border-radius: 8px;
    text-align: center;
    font-weight: 600;
    font-size: 18px;
}

.driver-popup {
    background: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    min-width: 200px;
}

.driver-popup h4 {
    margin: 0 0 10px 0;
    color: #2d3748;
    font-size: 16px;
}

.driver-popup p {
    margin: 5px 0;
    color: #4a5568;
    font-size: 14px;
}

/* New styles for cancel button */
.cancel-btn {
    background: #e53e3e;
    color: white;
}

.cancel-btn:hover {
    background: #c53030;
}

/* Map layers control styles */
.leaflet-control-layers {
    font-family: 'Cairo', sans-serif;
    direction: rtl;
    text-align: right;
}

/* ID verification preview */
.id-preview {
    max-width: 100%;
    border-radius: 8px;
    margin-top: 10px;
    border: 2px solid #e2e8f0;
}

.id-verification-message {
    margin-top: 10px;
    padding: 8px;
    border-radius: 8px;
    font-size: 14px;
    display: none;
}

.id-verification-message.valid {
    background: #c6f6d5;
    color: #22543d;
}

.id-verification-message.invalid {
    background: #fed7d7;
    color: #742a2a;
}

/* Trip control buttons */
.trip-control-buttons {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

.pickup-btn {
    background: #4299e1;
    color: white;
    flex: 1;
}

.pickup-btn:hover {
    background: #3182ce;
}

.end-trip-btn {
    background: #48bb78;
    color: white;
    flex: 1;
}

.end-trip-btn:hover {
    background: #38a169;
}

.trip-info {
    background: #edf2f7;
    border-radius: 8px;
    padding: 15px;
    margin-top: 15px;
    text-align: center;
}

.trip-info h4 {
    margin-top: 0;
    color: #2d3748;
}

.trip-info p {
    margin: 5px 0;
    color: #4a5568;
}

.trip-info .price {
    font-size: 24px;
    font-weight: 600;
    color: #2d3748;
    margin: 10px 0;
}

.passenger-info {
    background: #edf2f7;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
}

.passenger-info h4 {
    margin-top: 0;
    color: #2d3748;
}

.passenger-actions {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}

@media (max-width: 768px) {
    #mapPage {
        flex-direction: column;
    }

    #map {
        width: 100%;
        height: 60vh;
    }

    .sidebar {
        width: 100%;
        height: 40vh;
        padding: 20px;
    }

    .box {
        margin: 10px;
        padding: 20px;
    }

    .chat-container {
        width: 90%;
        right: 5%;
        left: 5%;
    }

    .notification {
        right: 10px;
        left: 10px;
        max-width: none;
    }
}
</style>
<script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js"></script>
</head>
<body>
<!-- صفحة تسجيل الدخول -->
<div class="box" id="loginPage">
    <h2>مرحباً بك في GRASIAS</h2>
    <div class="choice">
        <label>
            <input type="radio" name="role" value="sayeq">
            <span>🚗 سائق</span>
        </label>
        <label>
            <input type="radio" name="role" value="rakib">
            <span>🧍‍♀️ راكب</span>
        </label>
    </div>
    <button onclick="signInWithGoogle()">🔐 تسجيل الدخول باستخدام Google</button>
</div>

<!-- صفحة معلومات الراكب -->
<div class="box" id="passengerPage">
    <h2>معلومات الراكب</h2>
    <div class="success-message" id="passengerSuccess"></div>
    <div class="error-message" id="passengerError"></div>
    <input type="text" id="passengerName" placeholder="الاسم الكامل" required>
    <input type="tel" id="passengerPhone" placeholder="رقم الهاتف (مثال: 0612345678)" required>
    <div class="file-input-wrapper">
        <input type="file" id="passengerIdCard" accept="image/*" onchange="previewAndVerifyID(this, 'passengerIdPreview', 'passengerIdVerification')" />
        <label for="passengerIdCard" class="file-input-label">
            📄 اختر صورة بطاقة الهوية
        </label>
    </div>
    <img id="passengerIdPreview" class="id-preview" style="display: none;">
    <div id="passengerIdVerification" class="id-verification-message"></div>
    <button onclick="submitPassengerInfo()">متابعة ➡️</button>
</div>

<!-- صفحة معلومات السائق -->
<div class="box" id="driverPage">
    <h2>معلومات السائق</h2>
    <div class="success-message" id="driverSuccess"></div>
    <div class="error-message" id="driverError"></div>
    <input type="text" id="driverName" placeholder="الاسم الكامل" required>
    <input type="tel" id="driverPhone" placeholder="رقم الهاتف (مثال: 0612345678)" required>
    <input type="text" id="carType" placeholder="نوع السيارة (مثال: تويوتا كورولا)" required>
    <input type="text" id="carColor" placeholder="لون السيارة" required>
    <input type="text" id="plateNumber" placeholder="رقم لوحة السيارة" required>
    <div class="file-input-wrapper">
        <input type="file" id="driverId" accept="image/*" onchange="previewAndVerifyID(this, 'driverIdPreview', 'driverIdVerification')" required>
        <label for="driverId" class="file-input-label">
            📄 اختر صورة بطاقة الهوية
        </label>
    </div>
    <img id="driverIdPreview" class="id-preview" style="display: none;">
    <div id="driverIdVerification" class="id-verification-message"></div>
    
    <div class="file-input-wrapper">
        <input type="file" id="carCheck" accept="image/*" onchange="previewAndVerifyID(this, 'carCheckPreview', 'carCheckVerification')" required>
        <label for="carCheck" class="file-input-label">
            🔧 اختر صورة التشخيص التقني
        </label>
    </div>
    <img id="carCheckPreview" class="id-preview" style="display: none;">
    <div id="carCheckVerification" class="id-verification-message"></div>
    
    <button onclick="showDeclaration()">📜 عرض التعهد</button>
    <div class="declaration-box" id="declarationBox"></div>
    <button onclick="startDriverMap()">متابعة ➡️</button>
</div>

<!-- صفحة الخريطة -->
<div id="mapPage">
    <div id="map"></div>
    <div class="sidebar">
        <div id="tripStatus" class="trip-status" style="display: none;">
            <div id="tripStatusText"></div>
            <button id="cancelTripBtn" onclick="cancelTrip()" class="cancel-btn" style="display: none; margin-top: 10px;">❌ إلغاء الرحلة</button>
        </div>
        <h3 id="sidebarTitle">🚗 تفاصيل الرحلة</h3>

        <!-- محتوى الراكب -->
        <div id="passengerContent">
            <div id="nearbyDrivers">
                <h4>السائقون القريبون:</h4>
                <div id="driversList"></div>
            </div>
        </div>

        <!-- محتوى السائق -->
        <div id="driverContent" style="display: none;">
            <label>حالة السائق:</label>
            <select id="driverStatus" onchange="updateDriverStatus()">
                <option value="available">متاح</option>
                <option value="busy">مشغول</option>
                <option value="offline">غير متصل</option>
            </select>

            <label>عدد المقاعد المتاحة:</label>
            <input type="number" id="availableSeats" min="1" max="8" value="4">

            <label>ملاحظات السائق:</label>
            <textarea id="driverNotes" placeholder="معلومات إضافية للركاب..." style="height: 60px;"></textarea>

            <!-- معلومات الراكب الحالي -->
            <div id="currentPassengerInfo" class="passenger-info" style="display: none;">
                <h4>معلومات الراكب</h4>
                <div id="passengerDetails"></div>
                <div class="passenger-actions">
                    <button onclick="startChat(activeTrip.passengerId, activeTrip.passengerName)" class="chat-btn">💬 دردشة</button>
                    <button onclick="callPassenger()" class="call-btn">📞 اتصال</button>
                </div>
            </div>

            <!-- أزرار التحكم في الرحلة -->
            <div id="tripControls" class="trip-control-buttons" style="display: none;">
                <button id="pickupBtn" onclick="pickupPassenger()" class="pickup-btn">🚕 تم تركيب الراكب</button>
                <button id="endTripBtn" onclick="endTrip()" class="end-trip-btn" disabled>🏁 انتهاء الرحلة</button>
            </div>

            <!-- معلومات الرحلة والسعر -->
            <div id="tripInfo" class="trip-info" style="display: none;">
                <h4>معلومات الرحلة</h4>
                <p>المسافة المقطوعة: <span id="tripDistance">0</span> كم</p>
                <div class="price">السعر: <span id="tripPrice">0</span> دينار</div>
            </div>
        </div>

        <button onclick="activateRide()" id="activateBtn">🚗 تفعيل الرحلة</button>
        <button onclick="logout()" style="background: #e53e3e; margin-top: 10px;">🚪 تسجيل الخروج</button>
    </div>
</div>

<!-- نافذة الدردشة -->
<div id="chatContainer" class="chat-container">
    <div class="chat-header">
        <span id="chatTitle">الدردشة</span>
        <button onclick="closeChat()" style="background: none; border: none; color: white; cursor: pointer; padding: 0; margin: 0; width: auto;">✕</button>
    </div>
    <div id="chatMessages" class="chat-messages"></div>
    <div class="chat-input-container">
        <input type="text" id="chatInput" class="chat-input" placeholder="اكتب رسالتك...">
        <button onclick="sendMessage()" class="send-btn">إرسال</button>
    </div>
</div>

<!-- تحميل مكتبات Firebase -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, set, get, child, onValue, push, remove, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAekz29R9IwY1pygd4Mic5AX8XZ7A7Z4Fs",
        authDomain: "grasias-d7830.firebaseapp.com",
        databaseURL: "https://grasias-d7830-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "grasias-d7830",
        storageBucket: "grasias-d7830.appspot.com",
        messagingSenderId: "134413476604",
        appId: "1:134413476604:web:ab1acfa69c025218cbad79",
        measurementId: "G-6QBYM41CJ1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // جعل المتغيرات والدوال متاحة عالمياً
    window.currentUser = null;
    window.currentRole = null;
    window.db = db;
    window.auth = auth;
    window.ref = ref;
    window.set = set;
    window.get = get;
    window.update = update;
    window.push = push;
    window.onValue = onValue;
    window.remove = remove;

    window.signInWithGoogle = () => {
        const roleInput = document.querySelector('input[name="role"]:checked');
        if (!roleInput) {
            alert("يرجى اختيار الدور قبل تسجيل الدخول");
            return;
        }

        window.currentRole = roleInput.value;

        signInWithPopup(auth, provider)
            .then((result) => {
                const user = result.user;
                window.currentUser = user;

                const userRef = ref(db, `users/${user.uid}`);
                get(userRef).then((snapshot) => {
                    if (snapshot.exists()) {
                        const userData = snapshot.val();
                        window.currentRole = userData.role;
                        showPage("mapPage");
                        loadMap(user.displayName);
                        startLocationTracking();
                    } else {
                        set(userRef, {
                            name: user.displayName,
                            email: user.email,
                            role: window.currentRole,
                            createdAt: new Date().toISOString()
                        });

                        if (window.currentRole === "rakib") {
                            showPage("passengerPage");
                        } else {
                            showPage("driverPage");
                        }
                    }
                });
            })
            .catch((error) => {
                console.error("خطأ في تسجيل الدخول:", error);
                alert("فشل تسجيل الدخول: " + error.message);
            });
    };
</script>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
<script>
    let currentMap = null;
    let currentMarker = null;
    let driversMarkers = [];
    let passengersMarkers = [];
    let currentLocation = null;
    let selectedDriver = null;
    let currentTrip = null;
    let routeControl = null;
    let currentChatPartner = null;
    let mapLayers = {};
    let activeTrip = null;
    let tripStartLocation = null;
    let tripInProgress = false;
    let tripDistance = 0;
    let tripStartTime = null;
    let locationHistory = [];
    let watchPositionId = null;

    // أيقونات مخصصة للخريطة
    const driverIcon = L.divIcon({
        html: '🚗',
        iconSize: [30, 30],
        className: 'custom-div-icon'
    });

    const passengerIcon = L.divIcon({
        html: '🧍‍♀️',
        iconSize: [30, 30],
        className: 'custom-div-icon'
    });

    function showPage(id) {
        ["loginPage", "passengerPage", "driverPage", "mapPage"].forEach(p => {
            document.getElementById(p).style.display = "none";
        });
        document.getElementById(id).style.display = id === "mapPage" ? "flex" : "block";
    }

    function showMessage(type, message, pagePrefix = '') {
        const successEl = document.getElementById(pagePrefix + 'Success');
        const errorEl = document.getElementById(pagePrefix + 'Error');

        if (type === 'success') {
            successEl.textContent = message;
            successEl.style.display = 'block';
            errorEl.style.display = 'none';
        } else {
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            successEl.style.display = 'none';
        }

        setTimeout(() => {
            successEl.style.display = 'none';
            errorEl.style.display = 'none';
        }, 5000);
    }

    // التحقق من صورة بطاقة الهوية
    function previewAndVerifyID(input, previewId, verificationId) {
        const preview = document.getElementById(previewId);
        const verification = document.getElementById(verificationId);
        
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.style.display = 'block';
                
                // التحقق من الصورة (محاكاة للتحقق)
                verifyIDImage(e.target.result, verification);
            };
            
            reader.readAsDataURL(input.files[0]);
        }
    }
    
    // التحقق من صورة بطاقة الهوية (محاكاة)
    function verifyIDImage(imageData, verificationElement) {
        // محاكاة عملية التحقق - في الواقع يمكن استخدام خدمة AI للتحقق
        setTimeout(() => {
            // تحقق بسيط من حجم الصورة
            const img = new Image();
            img.src = imageData;
            
            img.onload = function() {
                if (img.width < 200 || img.height < 200) {
                    verificationElement.textContent = "⚠️ الصورة صغيرة جدًا. يرجى تحميل صورة أوضح.";
                    verificationElement.className = "id-verification-message invalid";
                } else {
                    // فحص عشوائي للتوضيح فقط (90% فرصة للقبول)
                    const isValid = Math.random() > 0.1;
                    
                    if (isValid) {
                        verificationElement.textContent = "✅ تم التحقق من الصورة بنجاح";
                        verificationElement.className = "id-verification-message valid";
                    } else {
                        verificationElement.textContent = "❌ لم يتم التعرف على بطاقة هوية في الصورة. يرجى المحاولة مرة أخرى.";
                        verificationElement.className = "id-verification-message invalid";
                    }
                }
                verificationElement.style.display = "block";
            };
        }, 1000);
    }

    // حساب ثمن المسافة
    function calculatePrice(distance) {
        if (!distance || distance <= 0) {
            return 0;
        }

        let totalPrice = 0;

        if (distance <= 20) {
            // من 1 إلى 20 كم: 10 دينار للكيلو
            totalPrice = distance * 10;
        } else if (distance <= 50) {
            // من 1 إلى 20: 10 دينار للكيلو
            // من 20 إلى 50: 5 دينار للكيلو
            totalPrice = (20 * 10) + ((distance - 20) * 5);
        } else {
            // من 1 إلى 20: 10 دينار للكيلو
            // من 20 إلى 50: 5 دينار للكيلو
            // من 50 فما فوق: 2 دينار للكيلو
            totalPrice = (20 * 10) + (30 * 5) + ((distance - 50) * 2);
        }

        return Math.round(totalPrice);
    }

    function loadMap(userName) {
        if (currentMap) {
            currentMap.remove();
        }

        currentMap = L.map('map').setView([28.0339, 1.6596], 6);
        
        // إضافة طبقات الخريطة المختلفة
        mapLayers = {
            "الخريطة الأساسية": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(currentMap),
            
            "صورة جوية": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '© Esri'
            }),
            
            "خريطة الطرق": L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors, Tiles style by Humanitarian OpenStreetMap Team'
            }),
            
            "خريطة النقل العام": L.tileLayer('https://{s}.tile.thunderforest.com/transport/{z}/{x}/{y}.png?apikey=6170aad10dfd42a38d4d8c709a536f38', {
                attribution: '© OpenStreetMap contributors, Maps © Thunderforest'
            })
        };
        
        // إضافة تحكم بطبقات الخريطة
        L.control.layers(null, mapLayers, {position: 'topright'}).addTo(currentMap);

        // تخصيص المحتوى حسب نوع المستخدم
        if (window.currentRole === 'rakib') {
            document.getElementById('passengerContent').style.display = 'block';
            document.getElementById('driverContent').style.display = 'none';
            document.getElementById('sidebarTitle').textContent = '🧍‍♀️ البحث عن سائق';
            document.getElementById('activateBtn').textContent = '🔍 البحث عن سائق';
        } else {
            document.getElementById('passengerContent').style.display = 'none';
            document.getElementById('driverContent').style.display = 'block';
            document.getElementById('sidebarTitle').textContent = '🚗 لوحة السائق';
            document.getElementById('activateBtn').textContent = '🚗 تفعيل الخدمة';
        }

        if (navigator.geolocation) {
            const geoOptions = {
                enableHighAccuracy: true, // استخدام دقة عالية
                timeout: 10000, // مهلة 10 ثوان
                maximumAge: 0 // عدم استخدام بيانات مخزنة مسبقًا
            };
            
            navigator.geolocation.getCurrentPosition(position => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                currentLocation = { lat, lng };

                currentMap.setView([lat, lng], 14);

                if (currentMarker) {
                    currentMap.removeLayer(currentMarker);
                }

                const icon = window.currentRole === 'rakib' ? passengerIcon : driverIcon;
                currentMarker = L.marker([lat, lng], { icon }).addTo(currentMap)
                    .bindPopup(`📍 ${userName}`)
                    .openPopup();

                // بدء تتبع الموقع
                startLocationTracking();
            }, (error) => {
                console.error("خطأ في تحديد الموقع:", error);
                alert("⚠️ تعذر تحديد موقعك. يرجى التأكد من تفعيل خدمة الموقع.");
            }, geoOptions);
        } else {
            alert("⚠️ المتصفح لا يدعم تحديد الموقع.");
        }
    }

    // تتبع الموقع المباشر بدقة عالية
    function startLocationTracking() {
        if (!window.currentUser) return;

        // إيقاف أي تتبع سابق
        if (watchPositionId) {
            navigator.geolocation.clearWatch(watchPositionId);
        }

        // خيارات تحديد الموقع بدقة عالية
        const geoOptions = {
            enableHighAccuracy: true, // استخدام دقة عالية
            timeout: 10000, // مهلة 10 ثوان
            maximumAge: 0 // عدم استخدام بيانات مخزنة مسبقًا
        };

        // بدء تتبع الموقع باستمرار
        watchPositionId = navigator.geolocation.watchPosition(position => {
            const newLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
                accuracy: position.coords.accuracy,
                role: window.currentRole,
                name: window.currentUser.displayName,
                timestamp: Date.now(),
                status: window.currentRole === 'sayeq' ? (document.getElementById('driverStatus')?.value || 'available') : 'active'
            };

            // إضافة معلومات السائق إذا كان سائقاً
            if (window.currentRole === 'sayeq') {
                const driverData = JSON.parse(localStorage.getItem('driverData') || '{}');
                newLocation.phone = driverData.phone || '';
                newLocation.carType = driverData.carType || '';
                newLocation.carColor = driverData.carColor || '';
                newLocation.plateNumber = driverData.plateNumber || '';
                newLocation.availableSeats = document.getElementById('availableSeats')?.value || 4;
                newLocation.notes = document.getElementById('driverNotes')?.value || '';
            }

            // تحديث الموقع في Firebase
            window.set(window.ref(window.db, `locations/${window.currentUser.uid}`), newLocation);

            // تحديث الموقع المحلي
            currentLocation = { lat: newLocation.lat, lng: newLocation.lng };

            // تحديث العلامة على الخريطة
            if (currentMarker) {
                currentMarker.setLatLng([newLocation.lat, newLocation.lng]);
            }
            
            // إذا كانت الرحلة جارية، تحديث المسافة المقطوعة
            if (tripInProgress && window.currentRole === 'sayeq') {
                // إضافة الموقع الجديد إلى سجل المواقع
                locationHistory.push({
                    lat: newLocation.lat,
                    lng: newLocation.lng,
                    timestamp: Date.now()
                });
                
                // حساب المسافة المقطوعة
                updateTripDistanceTraveled();
            }
        }, 
        (error) => {
            console.error("خطأ في تتبع الموقع:", error);
        }, 
        geoOptions);

        // مراقبة مواقع المستخدمين الآخرين
        if (window.currentRole === 'rakib') {
            watchDrivers();
        } else {
            watchPassengers();
        }

        // مراقبة طلبات الرحلات
        watchTripRequests();
    }

    // حساب المسافة المقطوعة خلال الرحلة
    function updateTripDistanceTraveled() {
        if (!tripInProgress || locationHistory.length < 2) return;
        
        // حساب المسافة بين النقاط المتتالية
        let totalDistance = 0;
        for (let i = 1; i < locationHistory.length; i++) {
            const prevLocation = locationHistory[i-1];
            const currentLocation = locationHistory[i];
            
            const segmentDistance = calculateDistance(
                prevLocation.lat, prevLocation.lng,
                currentLocation.lat, currentLocation.lng
            );
            
            // إضافة المسافة فقط إذا كانت معقولة (لتجنب القفزات الكبيرة بسبب أخطاء GPS)
            if (segmentDistance < 0.5) { // أقل من 500 متر بين القراءات
                totalDistance += segmentDistance;
            }
        }
        
        // تحديث المسافة والسعر
        tripDistance = totalDistance;
        document.getElementById('tripDistance').textContent = tripDistance.toFixed(2);
        
        const price = calculatePrice(tripDistance);
        document.getElementById('tripPrice').textContent = price;
        
        // تحديث معلومات الرحلة في Firebase
        if (activeTrip && activeTrip.id) {
            window.update(window.ref(window.db, `tripRequests/${activeTrip.id}`), {
                distance: tripDistance,
                price: price
            });
        }
    }

    // مراقبة السائقين للركاب
    function watchDrivers() {
        const driversRef = window.ref(window.db, 'locations');
        window.onValue(driversRef, (snapshot) => {
            const locations = snapshot.val();
            updateDriversOnMap(locations);
            updateDriversList(locations);
        });
    }

    // مراقبة الركاب للسائقين
    function watchPassengers() {
        const passengersRef = window.ref(window.db, 'locations');
        window.onValue(passengersRef, (snapshot) => {
            const locations = snapshot.val();
            updatePassengersOnMap(locations);
        });
    }

    // تحديث السائقين على الخريطة
    function updateDriversOnMap(locations) {
        // إزالة العلامات القديمة
        driversMarkers.forEach(marker => currentMap.removeLayer(marker));
        driversMarkers = [];

        if (!locations) return;

        Object.keys(locations).forEach(userId => {
            const location = locations[userId];
            if (location.role === 'sayeq' && location.status === 'available' && userId !== window.currentUser?.uid) {
                const marker = L.marker([location.lat, location.lng], { icon: driverIcon })
                    .addTo(currentMap);

                // إنشاء popup مع معلومات السائق الكاملة
                const popupContent = `
                <div class="driver-popup">
                    <h4>🚗 ${location.name}</h4>
                    <p><strong>📞 الهاتف:</strong> ${location.phone || 'غير متوفر'}</p>
                    <p><strong>🚙 نوع السيارة:</strong> ${location.carType || 'غير محدد'}</p>
                    <p><strong>🎨 لون السيارة:</strong> ${location.carColor || 'غير محدد'}</p>
                    <p><strong>🔢 رقم اللوحة:</strong> ${location.plateNumber || 'غير متوفر'}</p>
                    <p><strong>💺 المقاعد المتاحة:</strong> ${location.availableSeats || 4}</p>
                    ${location.notes ? `<p><strong>📝 ملاحظات:</strong> ${location.notes}</p>` : ''}
                </div>
                `;

                marker.bindPopup(popupContent);
                marker.userId = userId;
                driversMarkers.push(marker);
            }
        });
    }

    // تحديث الركاب على الخريطة
    function updatePassengersOnMap(locations) {
        // إزالة العلامات القديمة
        passengersMarkers.forEach(marker => currentMap.removeLayer(marker));
        passengersMarkers = [];

        if (!locations) return;

        Object.keys(locations).forEach(userId => {
            const location = locations[userId];
            if (location.role === 'rakib' && userId !== window.currentUser?.uid) {
                const marker = L.marker([location.lat, location.lng], { icon: passengerIcon })
                    .addTo(currentMap);

                const popupContent = `
                <div class="driver-popup">
                    <h4>🧍‍♀️ ${location.name}</h4>
                    <p><strong>📍 الموقع:</strong> راكب يبحث عن رحلة</p>
                </div>
                `;

                marker.bindPopup(popupContent);
                marker.userId = userId;
                passengersMarkers.push(marker);
            }
        });
    }

    // تحديث قائمة السائقين
    function updateDriversList(locations) {
        const driversList = document.getElementById('driversList');
        if (!driversList) return;

        driversList.innerHTML = '';

        if (!locations || !currentLocation) return;

        const availableDrivers = [];

        Object.keys(locations).forEach(userId => {
            const location = locations[userId];
            if (location.role === 'sayeq' && location.status === 'available' && userId !== window.currentUser?.uid) {
                const distance = calculateDistance(currentLocation.lat, currentLocation.lng, location.lat, location.lng);
                availableDrivers.push({ ...location, userId, distance });
            }
        });

        // ترتيب السائقين حسب المسافة
        availableDrivers.sort((a, b) => a.distance - b.distance);

        availableDrivers.forEach(driver => {
            const driverCard = document.createElement('div');
            driverCard.className = 'driver-card';
            driverCard.innerHTML = `
            <div class="driver-info">
                <span class="driver-name">🚗 ${driver.name}</span>
                <span class="driver-distance">${driver.distance.toFixed(1)} كم</span>
            </div>
            <div class="car-info">
                🚙 ${driver.carType || 'غير محدد'} - 🎨 ${driver.carColor || 'غير محدد'}
                <br>💺 ${driver.availableSeats || 4} مقاعد متاحة
            </div>
            <div class="driver-actions">
                <button class="action-btn call-btn" onclick="callDriver('${driver.phone}')">📞 اتصال</button>
                <button class="action-btn chat-btn" onclick="startChat('${driver.userId}', '${driver.name}')">💬 دردشة</button>
                <button class="action-btn select-btn" onclick="selectDriver('${driver.userId}')">✅ اختيار</button>
            </div>
            `;
            driversList.appendChild(driverCard);
        });

        if (availableDrivers.length === 0) {
            driversList.innerHTML = '<p style="text-align: center; color: #718096;">لا يوجد سائقون متاحون في المنطقة</p>';
        }
    }

    // حساب المسافة بين نقطتين
    function calculateDistance(lat1, lng1, lat2, lng2) {
        const R = 6371; // نصف قطر الأرض بالكيلومتر
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLng = (lng2 - lng1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng/2) * Math.sin(dLng/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    // اتصال بالسائق
    function callDriver(phone) {
        if (phone && phone !== 'غير متوفر') {
            window.open(`tel:${phone}`, '_self');
        } else {
            alert('رقم الهاتف غير متوفر');
        }
    }
    
    // اتصال بالراكب
    function callPassenger() {
        if (!activeTrip) return;
        
        // الحصول على رقم هاتف الراكب من قاعدة البيانات
        window.get(window.ref(window.db, `users/${activeTrip.passengerId}`))
            .then((snapshot) => {
                if (snapshot.exists()) {
                    const passengerData = snapshot.val();
                    if (passengerData.phone) {
                        window.open(`tel:${passengerData.phone}`, '_self');
                    } else {
                        alert('رقم هاتف الراكب غير متوفر');
                    }
                } else {
                    alert('معلومات الراكب غير متوفرة');
                }
            });
    }

    // بدء الدردشة
    function startChat(userId, userName) {
        currentChatPartner = { userId, userName };
        document.getElementById('chatTitle').textContent = `دردشة مع ${userName}`;
        document.getElementById('chatContainer').style.display = 'flex';
        loadChatMessages(userId);
    }

    // إغلاق الدردشة
    function closeChat() {
        document.getElementById('chatContainer').style.display = 'none';
        currentChatPartner = null;
    }

    // تحميل رسائل الدردشة
    function loadChatMessages(partnerId) {
        const chatId = [window.currentUser.uid, partnerId].sort().join('_');
        const messagesRef = window.ref(window.db, `chats/${chatId}/messages`);

        window.onValue(messagesRef, (snapshot) => {
            const messages = snapshot.val();
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';

            if (messages) {
                Object.keys(messages).forEach(messageId => {
                    const message = messages[messageId];
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${message.senderId === window.currentUser.uid ? 'sent' : 'received'}`;
                    messageDiv.textContent = message.text;
                    chatMessages.appendChild(messageDiv);
                });
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        });
    }

    // إرسال رسالة
    function sendMessage() {
        const chatInput = document.getElementById('chatInput');
        const messageText = chatInput.value.trim();

        if (!messageText || !currentChatPartner) return;

        const chatId = [window.currentUser.uid, currentChatPartner.userId].sort().join('_');
        const messagesRef = window.ref(window.db, `chats/${chatId}/messages`);

        window.push(messagesRef, {
            text: messageText,
            senderId: window.currentUser.uid,
            senderName: window.currentUser.displayName,
            timestamp: Date.now()
        });

        chatInput.value = '';
    }

    // اختيار سائق
    function selectDriver(driverId) {
        selectedDriver = driverId;

        // إرسال طلب رحلة للسائق
        const tripRequest = {
            passengerId: window.currentUser.uid,
            passengerName: window.currentUser.displayName,
            driverId: driverId,
            passengerLocation: currentLocation,
            status: 'pending',
            timestamp: Date.now()
        };

        window.push(window.ref(window.db, 'tripRequests'), tripRequest)
            .then((ref) => {
                const requestId = ref.key;
                showNotification('تم إرسال طلب الرحلة', 'في انتظار موافقة السائق...', 'info');
                
                // تخزين معرف الطلب للإلغاء لاحقًا إذا لزم الأمر
                localStorage.setItem('currentTripRequestId', requestId);
            });
    }

    // مراقبة طلبات الرحلات
    function watchTripRequests() {
        const requestsRef = window.ref(window.db, 'tripRequests');
        window.onValue(requestsRef, (snapshot) => {
            const requests = snapshot.val();
            if (!requests) return;

            Object.keys(requests).forEach(requestId => {
                const request = requests[requestId];

                // للسائق: عرض طلبات الرحلات الواردة
                if (window.currentRole === 'sayeq' && request.driverId === window.currentUser.uid && request.status === 'pending') {
                    showTripRequestNotification(request, requestId);
                }

                // للراكب: عرض حالة الطلب
                if (window.currentRole === 'rakib' && request.passengerId === window.currentUser.uid) {
                    updateTripStatus(request, requestId);
                }
                
                // للسائق: إذا تم قبول الرحلة، عرض المسار
                if (window.currentRole === 'sayeq' && request.driverId === window.currentUser.uid && 
                    (request.status === 'accepted' || request.status === 'pickup' || request.status === 'inProgress')) {
                    
                    if (!activeTrip || activeTrip.id !== requestId) {
                        activeTrip = { ...request, id: requestId };
                        
                        // عرض معلومات الراكب
                        showPassengerInfo(request);
                        
                        // رسم المسار إلى الراكب إذا لم تبدأ الرحلة بعد
                        if (request.status === 'accepted') {
                            drawRoute(currentLocation, request.passengerLocation);
                            document.getElementById('tripControls').style.display = 'flex';
                            document.getElementById('pickupBtn').disabled = false;
                            document.getElementById('endTripBtn').disabled = true;
                        }
                        
                        // تقليل عدد المقاعد المتاحة
                        const availableSeatsElement = document.getElementById('availableSeats');
                        if (availableSeatsElement) {
                            const currentSeats = parseInt(availableSeatsElement.value) || 4;
                            if (currentSeats > 1) {
                                availableSeatsElement.value = currentSeats - 1;
                                updateDriverStatus(); // تحديث المعلومات في قاعدة البيانات
                            }
                        }
                    }
                    
                    // إذا كانت الرحلة قيد التنفيذ، تحديث حالة الرحلة
                    if (request.status === 'pickup' && !tripInProgress) {
                        // تم تركيب الراكب، بدء حساب المسافة
                        tripInProgress = true;
                        tripStartLocation = { ...currentLocation };
                        tripStartTime = Date.now();
                        locationHistory = [{ ...currentLocation, timestamp: tripStartTime }];
                        document.getElementById('pickupBtn').disabled = true;
                        document.getElementById('endTripBtn').disabled = false;
                        document.getElementById('tripInfo').style.display = 'block';
                    }
                }
            });
        });
    }
    
    // عرض معلومات الراكب للسائق
    function showPassengerInfo(request) {
        const passengerInfoDiv = document.getElementById('currentPassengerInfo');
        const passengerDetailsDiv = document.getElementById('passengerDetails');
        
        // الحصول على معلومات الراكب من قاعدة البيانات
        window.get(window.ref(window.db, `users/${request.passengerId}`))
            .then((snapshot) => {
                if (snapshot.exists()) {
                    const passengerData = snapshot.val();
                    passengerDetailsDiv.innerHTML = `
                        <p><strong>الاسم:</strong> ${request.passengerName}</p>
                        <p><strong>الهاتف:</strong> ${passengerData.phone || 'غير متوفر'}</p>
                    `;
                    passengerInfoDiv.style.display = 'block';
                }
            });
    }

    // تم تركيب الراكب
    function pickupPassenger() {
        if (!activeTrip) return;
        
        // تحديث حالة الرحلة
        window.update(window.ref(window.db, `tripRequests/${activeTrip.id}`), {
            status: 'pickup',
            pickupTime: Date.now(),
            pickupLocation: currentLocation
        }).then(() => {
            // بدء حساب المسافة
            tripInProgress = true;
            tripStartLocation = { ...currentLocation };
            tripStartTime = Date.now();
            locationHistory = [{ ...currentLocation, timestamp: tripStartTime }];
            
            // تحديث واجهة المستخدم
            document.getElementById('pickupBtn').disabled = true;
            document.getElementById('endTripBtn').disabled = false;
            document.getElementById('tripInfo').style.display = 'block';
            
            // إزالة المسار السابق
            if (routeControl) {
                currentMap.removeControl(routeControl);
                routeControl = null;
            }
            
            showNotification('تم تركيب الراكب', 'بدأ حساب المسافة والسعر', 'success');
        });
    }
    
    // إنهاء الرحلة
    function endTrip() {
        if (!activeTrip || !tripInProgress) return;
        
        // حساب السعر النهائي
        const finalPrice = calculatePrice(tripDistance);
        
        // تحديث حالة الرحلة
        window.update(window.ref(window.db, `tripRequests/${activeTrip.id}`), {
            status: 'completed',
            endTime: Date.now(),
            endLocation: currentLocation,
            distance: tripDistance,
            price: finalPrice
        }).then(() => {
            // إعادة تعيين حالة الرحلة
            tripInProgress = false;
            
            // عرض ملخص الرحلة
            showNotification('تم إنهاء الرحلة', `المسافة: ${tripDistance.toFixed(2)} كم | السعر: ${finalPrice} دينار`, 'success');
            
            // إعادة تعيين واجهة المستخدم
            document.getElementById('tripControls').style.display = 'none';
            document.getElementById('currentPassengerInfo').style.display = 'none';
            
            // إعادة عدد المقاعد المتاحة
            const availableSeatsElement = document.getElementById('availableSeats');
            if (availableSeatsElement) {
                const currentSeats = parseInt(availableSeatsElement.value) || 3;
                availableSeatsElement.value = currentSeats + 1;
                updateDriverStatus(); // تحديث المعلومات في قاعدة البيانات
            }
            
            // إعادة تعيين المتغيرات
            activeTrip = null;
            tripStartLocation = null;
            locationHistory = [];
        });
    }

    // رسم المسار بين نقطتين
    function drawRoute(start, end) {
        // إزالة المسار السابق إن وجد
        if (routeControl) {
            currentMap.removeControl(routeControl);
        }
        
        // إنشاء مسار جديد
        routeControl = L.Routing.control({
            waypoints: [
                L.latLng(start.lat, start.lng),
                L.latLng(end.lat, end.lng)
            ],
            routeWhileDragging: false,
            showAlternatives: false,
            fitSelectedRoutes: true,
            lineOptions: {
                styles: [
                    {color: '#667eea', opacity: 0.8, weight: 6}
                ]
            },
            createMarker: function() { return null; } // لا نريد إنشاء علامات جديدة
        }).addTo(currentMap);
    }

    // عرض إشعار طلب الرحلة للسائق
    function showTripRequestNotification(request, requestId) {
        // تجنب عرض إشعارات متكررة
        if (document.querySelector(`.notification[data-request-id="${requestId}"]`)) {
            return;
        }
        
        const notification = document.createElement('div');
        notification.className = 'notification';
        notification.setAttribute('data-request-id', requestId);
        notification.innerHTML = `
        <div class="notification-title">🚗 طلب رحلة جديد</div>
        <div class="notification-content">
            الراكب: ${request.passengerName}<br>
            المسافة: ${calculateDistance(currentLocation.lat, currentLocation.lng, request.passengerLocation.lat, request.passengerLocation.lng).toFixed(1)} كم
        </div>
        <div class="notification-actions">
            <button class="accept-btn" onclick="acceptTrip('${requestId}')">قبول</button>
            <button class="reject-btn" onclick="rejectTrip('${requestId}')">رفض</button>
        </div>
        `;
        document.body.appendChild(notification);

        // إزالة الإشعار بعد 30 ثانية
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 30000);
    }

    // قبول الرحلة
    function acceptTrip(requestId) {
        window.get(window.ref(window.db, `tripRequests/${requestId}`))
            .then((snapshot) => {
                if (snapshot.exists()) {
                    const request = snapshot.val();
                    
                    window.update(window.ref(window.db, `tripRequests/${requestId}`), {
                        status: 'accepted',
                        acceptedAt: Date.now()
                    });
                    
                    // تخزين الرحلة النشطة
                    activeTrip = { ...request, id: requestId, status: 'accepted' };
                    
                    // عرض معلومات الراكب
                    showPassengerInfo(request);
                    
                    // رسم المسار إلى الراكب
                    drawRoute(currentLocation, request.passengerLocation);
                    
                    // عرض أزرار التحكم في الرحلة
                    document.getElementById('tripControls').style.display = 'flex';
                    document.getElementById('pickupBtn').disabled = false;
                    document.getElementById('endTripBtn').disabled = true;
                    
                    // تقليل عدد المقاعد المتاحة
                    const availableSeatsElement = document.getElementById('availableSeats');
                    if (availableSeatsElement) {
                        const currentSeats = parseInt(availableSeatsElement.value) || 4;
                        if (currentSeats > 1) {
                            availableSeatsElement.value = currentSeats - 1;
                            updateDriverStatus(); // تحديث المعلومات في قاعدة البيانات
                        }
                    }
                }
            });

        // إزالة الإشعار
        const notifications = document.querySelectorAll(`.notification[data-request-id="${requestId}"]`);
        notifications.forEach(notification => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        });

        showNotification('تم قبول الرحلة', 'يمكنك الآن التواصل مع الراكب', 'success');
    }

    // رفض الرحلة
    function rejectTrip(requestId) {
        window.update(window.ref(window.db, `tripRequests/${requestId}`), {
            status: 'rejected',
            rejectedAt: Date.now()
        });

        // إزالة الإشعار
        const notifications = document.querySelectorAll(`.notification[data-request-id="${requestId}"]`);
        notifications.forEach(notification => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        });
    }

    // تحديث حالة الرحلة للراكب
    function updateTripStatus(request, requestId) {
        const statusDiv = document.getElementById('tripStatus');
        const statusText = document.getElementById('tripStatusText');
        const cancelBtn = document.getElementById('cancelTripBtn');

        if (request.status === 'pending') {
            statusDiv.style.display = 'block';
            statusText.textContent = '⏳ في انتظار موافقة السائق...';
            statusDiv.className = 'trip-status';
            cancelBtn.style.display = 'block';
            
            // تخزين معرف الطلب للإلغاء
            localStorage.setItem('currentTripRequestId', requestId);
        } else if (request.status === 'accepted') {
            statusDiv.style.display = 'block';
            statusText.textContent = '✅ تم قبول الرحلة! السائق في الطريق إليك';
            statusDiv.className = 'trip-status active';
            cancelBtn.style.display = 'block';
            
            // تخزين معرف الطلب للإلغاء
            localStorage.setItem('currentTripRequestId', requestId);
            
            // بدء الدردشة مع السائق
            startChat(request.driverId, "السائق");
            
            // تخزين الرحلة النشطة
            activeTrip = { ...request, id: requestId };
        } else if (request.status === 'pickup') {
            statusDiv.style.display = 'block';
            statusText.textContent = '🚕 بدأت الرحلة! رحلة سعيدة';
            statusDiv.className = 'trip-status active';
            cancelBtn.style.display = 'block';
            
            // تخزين معرف الطلب للإلغاء
            localStorage.setItem('currentTripRequestId', requestId);
            
            // تخزين الرحلة النشطة
            activeTrip = { ...request, id: requestId };
        } else if (request.status === 'completed') {
            statusDiv.style.display = 'block';
            statusText.innerHTML = `✅ تمت الرحلة بنجاح!<br>المسافة: ${request.distance?.toFixed(2) || 0} كم<br>السعر: ${request.price || 0} دينار`;
            statusDiv.className = 'trip-status active';
            cancelBtn.style.display = 'none';
            
            // مسح معرف الطلب
            localStorage.removeItem('currentTripRequestId');
            
            // مسح الرحلة النشطة بعد 30 ثانية
            setTimeout(() => {
                statusDiv.style.display = 'none';
                activeTrip = null;
            }, 30000);
        } else if (request.status === 'rejected') {
            statusDiv.style.display = 'block';
            statusText.textContent = '❌ تم رفض الرحلة. يمكنك البحث عن سائق آخر';
            statusDiv.className = 'trip-status';
            cancelBtn.style.display = 'none';
            
            // مسح معرف الطلب
            localStorage.removeItem('currentTripRequestId');
        } else if (request.status === 'cancelled') {
            statusDiv.style.display = 'block';
            statusText.textContent = '🚫 تم إلغاء الرحلة';
            statusDiv.className = 'trip-status';
            cancelBtn.style.display = 'none';
            
            // مسح معرف الطلب
            localStorage.removeItem('currentTripRequestId');
        }
    }

    // إلغاء الرحلة
    function cancelTrip() {
        const requestId = localStorage.getItem('currentTripRequestId');
        if (!requestId) {
            showNotification('خطأ', 'لا توجد رحلة نشطة للإلغاء', 'error');
            return;
        }
        
        window.update(window.ref(window.db, `tripRequests/${requestId}`), {
            status: 'cancelled',
            cancelledAt: Date.now(),
            cancelledBy: window.currentUser.uid
        }).then(() => {
            showNotification('تم إلغاء الرحلة', 'تم إلغاء الرحلة بنجاح', 'success');
            
            // إعادة تعيين واجهة المستخدم
            const statusDiv = document.getElementById('tripStatus');
            const statusText = document.getElementById('tripStatusText');
            const cancelBtn = document.getElementById('cancelTripBtn');
            
            statusDiv.style.display = 'block';
            statusText.textContent = '🚫 تم إلغاء الرحلة';
            statusDiv.className = 'trip-status';
            cancelBtn.style.display = 'none';
            
            // إزالة المسار إذا كان السائق
            if (window.currentRole === 'sayeq' && routeControl) {
                currentMap.removeControl(routeControl);
                routeControl = null;
                
                // إعادة عدد المقاعد المتاحة
                if (activeTrip) {
                    const availableSeatsElement = document.getElementById('availableSeats');
                    if (availableSeatsElement) {
                        const currentSeats = parseInt(availableSeatsElement.value) || 3;
                        availableSeatsElement.value = currentSeats + 1;
                        updateDriverStatus(); // تحديث المعلومات في قاعدة البيانات
                    }
                }
                
                // إخفاء معلومات الراكب وأزرار التحكم
                document.getElementById('currentPassengerInfo').style.display = 'none';
                document.getElementById('tripControls').style.display = 'none';
                document.getElementById('tripInfo').style.display = 'none';
            }
            
            // إعادة تعيين المتغيرات
            tripInProgress = false;
            activeTrip = null;
            tripStartLocation = null;
            locationHistory = [];
            
            // مسح معرف الطلب
            localStorage.removeItem('currentTripRequestId');
        });
    }

    // عرض إشعار
    function showNotification(title, content, type) {
        const notification = document.createElement('div');
        notification.className = 'notification';
        notification.innerHTML = `
        <div class="notification-title">${title}</div>
        <div class="notification-content">${content}</div>
        `;
        document.body.appendChild(notification);

        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 5000);
    }

    // تحديث حالة السائق
    function updateDriverStatus() {
        const status = document.getElementById('driverStatus').value;
        const availableSeats = document.getElementById('availableSeats').value;
        const notes = document.getElementById('driverNotes').value;
        
        if (window.currentUser && currentLocation) {
            window.update(window.ref(window.db, `locations/${window.currentUser.uid}`), {
                status: status,
                availableSeats: availableSeats,
                notes: notes
            });
        }
    }

    // تفعيل الرحلة
    function activateRide() {
        if (window.currentRole === 'rakib') {
            // للراكب: البحث عن سائق
            showMessage('success', 'جاري البحث عن السائقين المتاحين...');
        } else {
            // للسائق: تفعيل الخدمة
            const status = document.getElementById('driverStatus').value;
            if (status === 'available') {
                showMessage('success', 'تم تفعيل خدمة السائق بنجاح!');
            } else {
                showMessage('error', 'يجب تغيير حالتك إلى "متاح" لتفعيل الخدمة');
            }
        }
    }

    // إرسال معلومات الراكب
    function submitPassengerInfo() {
        const name = document.getElementById('passengerName').value;
        const phone = document.getElementById('passengerPhone').value;
        const idCard = document.getElementById('passengerIdCard').files[0];
        const idVerification = document.getElementById('passengerIdVerification');

        if (!name || !phone || !idCard) {
            showMessage('error', 'يرجى ملء جميع الحقول المطلوبة', 'passenger');
            return;
        }
        
        // التحقق من صحة بطاقة الهوية
        if (idVerification.className.includes('invalid')) {
            showMessage('error', 'يرجى تحميل صورة صالحة لبطاقة الهوية', 'passenger');
            return;
        }

        // حفظ البيانات محلياً
        localStorage.setItem('passengerData', JSON.stringify({ name, phone }));

        // حفظ في Firebase
        window.update(window.ref(window.db, `users/${window.currentUser.uid}`), {
            name: name,
            phone: phone,
            profileComplete: true
        }).then(() => {
            showMessage('success', 'تم حفظ معلوماتك بنجاح!', 'passenger');
            setTimeout(() => {
                showPage("mapPage");
                loadMap(name);
                startLocationTracking();
            }, 2000);
        });
    }

    // بدء خريطة السائق
    function startDriverMap() {
        const name = document.getElementById('driverName').value;
        const phone = document.getElementById('driverPhone').value;
        const carType = document.getElementById('carType').value;
        const carColor = document.getElementById('carColor').value;
        const plateNumber = document.getElementById('plateNumber').value;
        const driverIdVerification = document.getElementById('driverIdVerification');
        const carCheckVerification = document.getElementById('carCheckVerification');

        if (!name || !phone || !carType || !carColor || !plateNumber) {
            showMessage('error', 'يرجى ملء جميع الحقول المطلوبة', 'driver');
            return;
        }
        
        // التحقق من صحة المستندات
        if (driverIdVerification.className.includes('invalid')) {
            showMessage('error', 'يرجى تحميل صورة صالحة لبطاقة الهوية', 'driver');
            return;
        }
        
        if (carCheckVerification.className.includes('invalid')) {
            showMessage('error', 'يرجى تحميل صورة صالحة للتشخيص التقني', 'driver');
            return;
        }

        // حفظ البيانات محلياً
        localStorage.setItem('driverData', JSON.stringify({
            name, phone, carType, carColor, plateNumber
        }));

        // حفظ في Firebase
        window.update(window.ref(window.db, `users/${window.currentUser.uid}`), {
            name: name,
            phone: phone,
            carType: carType,
            carColor: carColor,
            plateNumber: plateNumber,
            profileComplete: true
        }).then(() => {
            showMessage('success', 'تم حفظ معلوماتك بنجاح!', 'driver');
            setTimeout(() => {
                showPage("mapPage");
                loadMap(name);
                startLocationTracking();
            }, 2000);
        });
    }

    // عرض التعهد
    function showDeclaration() {
        const declarationBox = document.getElementById('declarationBox');
        declarationBox.innerHTML = `
        <h4>تعهد السائق</h4>
        <p>أتعهد بأن:</p>
        <ul style="text-align: right;">
            <li>جميع المعلومات المقدمة صحيحة ودقيقة</li>
            <li>سيارتي في حالة جيدة وصالحة للقيادة</li>
            <li>أحمل رخصة قيادة سارية المفعول</li>
            <li>سأقوم بتوفير خدمة آمنة ومهذبة للركاب</li>
            <li>سأحترم قوانين المرور وأنظمة السلامة</li>
        </ul>
        `;
        declarationBox.style.display = 'block';
    }

    // تسجيل الخروج
    function logout() {
        if (window.currentUser) {
            // إزالة الموقع من Firebase
            window.set(window.ref(window.db, `locations/${window.currentUser.uid}`), null);
        }

        window.currentUser = null;
        window.currentRole = null;
        localStorage.clear();
        showPage('loginPage');
    }

    // إضافة مستمع لإرسال الرسالة بالضغط على Enter
    document.addEventListener('DOMContentLoaded', function() {
        const chatInput = document.getElementById('chatInput');
        if (chatInput) {
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        }
    });
</script>
</body>
</html>
