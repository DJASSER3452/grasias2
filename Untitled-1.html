<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GRASIAS</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, set, get, child, onValue, push, remove, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAekz29R9IwY1pygd4Mic5AX8XZ7A7Z4Fs",
      authDomain: "grasias-d7830.firebaseapp.com",
      databaseURL: "https://grasias-d7830-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "grasias-d7830",
      storageBucket: "grasias-d7830.appspot.com",
      messagingSenderId: "134413476604",
      appId: "1:134413476604:web:ab1acfa69c025218cbad79",
      measurementId: "G-6QBYM41CJ1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
    window.currentUser = null;
    window.currentRole = null;
    window.db = db;
    window.auth = auth;

    window.signInWithGoogle = () => {
      const roleInput = document.querySelector('input[name="role"]:checked');
      if (!roleInput) {
        alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¯ÙˆØ± Ù‚Ø¨Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
        return;
      }
      window.currentRole = roleInput.value;

      signInWithPopup(auth, provider)
        .then((result) => {
          const user = result.user;
          window.currentUser = user;
          const userRef = ref(db, `users/${user.uid}`);

          get(userRef).then((snapshot) => {
            if (snapshot.exists()) {
              const userData = snapshot.val();
              window.currentRole = userData.role;
              showPage("mapPage");
              loadMap(user.displayName);
              startLocationTracking();
            } else {
              set(userRef, {
                name: user.displayName,
                email: user.email,
                role: window.currentRole,
                createdAt: new Date().toISOString()
              });
              
              if (window.currentRole === "rakib") {
                showPage("passengerPage");
              } else {
                showPage("driverPage");
              }
            }
          });
        })
        .catch((error) => {
          console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:", error);
          alert("ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: " + error.message);
        });
    };
  </script>
  
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Cairo', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      direction: rtl;
      padding: 20px;
    }
    
    .box {
      background: white;
      padding: 30px 25px;
      border-radius: 20px;
      box-shadow: 0 15px 50px rgba(0,0,0,0.2);
      width: 100%;
      max-width: 400px;
      text-align: center;
      animation: fadeIn 0.6s ease-in-out;
    }
    
    @keyframes fadeIn {
      from { 
        opacity: 0; 
        transform: translateY(30px); 
      }
      to { 
        opacity: 1; 
        transform: translateY(0); 
      }
    }
    
    h2 { 
      margin-bottom: 25px; 
      color: #4a5568; 
      font-weight: 600;
      font-size: 24px;
    }
    
    input, button, textarea {
      width: 100%;
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 15px;
      font-size: 16px;
      border: 2px solid #e2e8f0;
      transition: all 0.3s ease;
      font-family: 'Cairo', sans-serif;
    }
    
    input:focus, textarea:focus {
      border-color: #667eea;
      outline: none;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: transform 0.2s ease;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    .choice { 
      text-align: right; 
      margin: 25px 0; 
    }
    
    .choice label { 
      display: flex;
      align-items: center;
      margin-bottom: 12px; 
      font-size: 16px;
      cursor: pointer;
      padding: 10px;
      border-radius: 8px;
      transition: background-color 0.2s ease;
    }
    
    .choice label:hover {
      background-color: #f7fafc;
    }
    
    .choice input[type="radio"] {
      width: auto;
      margin-left: 10px;
      margin-bottom: 0;
    }
    
    .declaration-box {
      margin-top: 20px;
      background: #f8f9fa;
      padding: 20px;
      border-radius: 12px;
      text-align: right;
      display: none;
      border-right: 4px solid #667eea;
      line-height: 1.6;
    }
    
    #mapPage {
      display: none;
      height: 100vh;
      width: 100vw;
      flex-direction: row;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    }
    
    #map { 
      width: 65%; 
      height: 100vh; 
    }
    
    .sidebar {
      width: 35%;
      background: #fff;
      padding: 30px;
      overflow-y: auto;
      box-shadow: -2px 0 10px rgba(0,0,0,0.1);
    }
    
    .sidebar h3 {
      color: #4a5568;
      margin-bottom: 20px;
      font-size: 20px;
    }
    
    .sidebar label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #2d3748;
    }
    
    #passengerPage, #driverPage, #mapPage {
      display: none;
    }
    
    .file-input-wrapper {
      position: relative;
      margin-bottom: 15px;
    }
    
    .file-input-wrapper input[type="file"] {
      opacity: 0;
      position: absolute;
      z-index: -1;
    }
    
    .file-input-label {
      display: block;
      padding: 15px;
      background: #f8f9fa;
      border: 2px dashed #cbd5e0;
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .file-input-label:hover {
      border-color: #667eea;
      background: #edf2f7;
    }
    
    .success-message {
      background: #c6f6d5;
      color: #22543d;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      display: none;
    }
    
    .error-message {
      background: #fed7d7;
      color: #742a2a;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      display: none;
    }

    /* Ø£Ù†Ù…Ø§Ø· Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù…Ø¶Ø§ÙØ© */
    .driver-card {
      background: white;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border: 2px solid transparent;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .driver-card:hover {
      border-color: #667eea;
      transform: translateY(-2px);
    }

    .driver-card.selected {
      border-color: #48bb78;
      background: #f0fff4;
    }

    .driver-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .driver-name {
      font-weight: 600;
      color: #2d3748;
      font-size: 16px;
    }

    .driver-distance {
      background: #667eea;
      color: white;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
    }

    .car-info {
      color: #718096;
      font-size: 14px;
      margin-bottom: 10px;
    }

    .driver-actions {
      display: flex;
      gap: 10px;
    }

    .action-btn {
      flex: 1;
      padding: 8px 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .call-btn {
      background: #48bb78;
      color: white;
    }

    .call-btn:hover {
      background: #38a169;
    }

    .chat-btn {
      background: #4299e1;
      color: white;
    }

    .chat-btn:hover {
      background: #3182ce;
    }

    .select-btn {
      background: #667eea;
      color: white;
    }

    .select-btn:hover {
      background: #5a67d8;
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      border-right: 4px solid #667eea;
      z-index: 1000;
      max-width: 350px;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .notification-title {
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 10px;
    }

    .notification-content {
      color: #4a5568;
      margin-bottom: 15px;
      line-height: 1.5;
    }

    .notification-actions {
      display: flex;
      gap: 10px;
    }

    .accept-btn {
      background: #48bb78;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }

    .reject-btn {
      background: #e53e3e;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }

    .chat-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 300px;
      height: 400px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      display: none;
      flex-direction: column;
      z-index: 1000;
    }

    .chat-header {
      background: #667eea;
      color: white;
      padding: 15px;
      border-radius: 12px 12px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .chat-messages {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      max-height: 250px;
    }

    .chat-input-container {
      padding: 15px;
      border-top: 1px solid #e2e8f0;
      display: flex;
      gap: 10px;
    }

    .chat-input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      margin: 0;
    }

    .send-btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      margin: 0;
      width: auto;
    }

    .message {
      margin-bottom: 10px;
      padding: 8px 12px;
      border-radius: 8px;
      max-width: 80%;
    }

    .message.sent {
      background: #667eea;
      color: white;
      margin-left: auto;
      text-align: left;
    }

    .message.received {
      background: #f7fafc;
      color: #2d3748;
      margin-right: auto;
    }

    .trip-status {
      background: #e6fffa;
      border: 1px solid #81e6d9;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      text-align: center;
    }

    .trip-status.active {
      background: #f0fff4;
      border-color: #9ae6b4;
    }

    @media (max-width: 768px) {
      #mapPage {
        flex-direction: column;
      }
      
      #map {
        width: 100%;
        height: 60vh;
      }
      
      .sidebar {
        width: 100%;
        height: 40vh;
        padding: 20px;
      }
      
      .box {
        margin: 10px;
        padding: 20px;
      }

      .chat-container {
        width: 90%;
        right: 5%;
        left: 5%;
      }

      .notification {
        right: 10px;
        left: 10px;
        max-width: none;
      }
    }
  </style>
</head>
<body>

<!-- ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div class="box" id="loginPage">
  <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ GRASIAS</h2>
  <div class="choice">
    <label>
      <input type="radio" name="role" value="sayeq"> 
      <span>ğŸš— Ø³Ø§Ø¦Ù‚</span>
    </label>
    <label>
      <input type="radio" name="role" value="rakib"> 
      <span>ğŸ§â€â™€ï¸ Ø±Ø§ÙƒØ¨</span>
    </label>
  </div>
  <button onclick="signInWithGoogle()">ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Google</button>
</div>

<!-- ØµÙØ­Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±Ø§ÙƒØ¨ -->
<div class="box" id="passengerPage">
  <h2>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±Ø§ÙƒØ¨</h2>
  <div class="success-message" id="passengerSuccess"></div>
  <div class="error-message" id="passengerError"></div>
  
  <input type="text" id="passengerName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" required>
  <input type="tel" id="passengerPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ù…Ø«Ø§Ù„: 0612345678)" required>
  
  <div class="file-input-wrapper">
    <input type="file" id="passengerIdCard" accept="image/*" />
    <label for="passengerIdCard" class="file-input-label">
      ğŸ“„ Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù‡ÙˆÙŠØ©
    </label>
  </div>
  
  <button onclick="submitPassengerInfo()">Ù…ØªØ§Ø¨Ø¹Ø© â¡ï¸</button>
</div>

<!-- ØµÙØ­Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ -->
<div class="box" id="driverPage">
  <h2>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚</h2>
  <div class="success-message" id="driverSuccess"></div>
  <div class="error-message" id="driverError"></div>
  
  <input type="text" id="driverName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" required>
  <input type="tel" id="driverPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ù…Ø«Ø§Ù„: 0612345678)" required>
  <input type="text" id="carType" placeholder="Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø© (Ù…Ø«Ø§Ù„: ØªÙˆÙŠÙˆØªØ§ ÙƒÙˆØ±ÙˆÙ„Ø§)" required>
  <input type="text" id="carColor" placeholder="Ù„ÙˆÙ† Ø§Ù„Ø³ÙŠØ§Ø±Ø©" required>
  <input type="text" id="plateNumber" placeholder="Ø±Ù‚Ù… Ù„ÙˆØ­Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©" required>
  
  <div class="file-input-wrapper">
    <input type="file" id="driverId" accept="image/*" required>
    <label for="driverId" class="file-input-label">
      ğŸ“„ Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù‡ÙˆÙŠØ©
    </label>
  </div>
  
  <div class="file-input-wrapper">
    <input type="file" id="carCheck" accept="image/*" required>
    <label for="carCheck" class="file-input-label">
      ğŸ”§ Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø§Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„ØªÙ‚Ù†ÙŠ
    </label>
  </div>
  
  <button onclick="showDeclaration()">ğŸ“œ Ø¹Ø±Ø¶ Ø§Ù„ØªØ¹Ù‡Ø¯</button>
  <div class="declaration-box" id="declarationBox"></div>
  <button onclick="startDriverMap()">Ù…ØªØ§Ø¨Ø¹Ø© â¡ï¸</button>
</div>

<!-- ØµÙØ­Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© -->
<div id="mapPage">
  <div id="map"></div>
  <div class="sidebar">
    <div id="tripStatus" class="trip-status" style="display: none;">
      <div id="tripStatusText"></div>
    </div>
    
    <h3 id="sidebarTitle">ğŸš— ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø­Ù„Ø©</h3>
    
    <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø§ÙƒØ¨ -->
    <div id="passengerContent">
      <label>Ø§Ù„ÙˆØ¬Ù‡Ø©:</label>
      <input type="text" id="destination" placeholder="Ø£Ø¯Ø®Ù„ ÙˆØ¬Ù‡ØªÙƒ (Ù…Ø«Ø§Ù„: Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±)">
      
      <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø±ÙƒØ§Ø¨:</label>
      <input type="number" id="passengers" min="1" max="8" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø±ÙƒØ§Ø¨" value="1">
      
      <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©:</label>
      <textarea id="notes" placeholder="Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø®Ø§ØµØ©..." style="height: 80px; resize: vertical;"></textarea>
      
      <div id="nearbyDrivers">
        <h4>Ø§Ù„Ø³Ø§Ø¦Ù‚ÙˆÙ† Ø§Ù„Ù‚Ø±ÙŠØ¨ÙˆÙ†:</h4>
        <div id="driversList"></div>
      </div>
    </div>

    <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø³Ø§Ø¦Ù‚ -->
    <div id="driverContent" style="display: none;">
      <label>Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚:</label>
      <select id="driverStatus" onchange="updateDriverStatus()">
        <option value="available">Ù…ØªØ§Ø­</option>
        <option value="busy">Ù…Ø´ØºÙˆÙ„</option>
        <option value="offline">ØºÙŠØ± Ù…ØªØµÙ„</option>
      </select>
      
      <label>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯ Ø§Ù„Ù…ØªØ§Ø­Ø©:</label>
      <input type="number" id="availableSeats" min="1" max="8" value="4">
      
      <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚:</label>
      <textarea id="driverNotes" placeholder="Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø±ÙƒØ§Ø¨..." style="height: 60px;"></textarea>
    </div>
    
    <button onclick="activateRide()" id="activateBtn">ğŸš— ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø±Ø­Ù„Ø©</button>
    <button onclick="logout()" style="background: #e53e3e; margin-top: 10px;">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
  </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© -->
<div id="chatContainer" class="chat-container">
  <div class="chat-header">
    <span id="chatTitle">Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</span>
    <button onclick="closeChat()" style="background: none; border: none; color: white; cursor: pointer; padding: 0; margin: 0; width: auto;">âœ•</button>
  </div>
  <div id="chatMessages" class="chat-messages"></div>
  <div class="chat-input-container">
    <input type="text" id="chatInput" class="chat-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ...">
    <button onclick="sendMessage()" class="send-btn">Ø¥Ø±Ø³Ø§Ù„</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  let currentMap = null;
  let currentMarker = null;
  let driversMarkers = [];
  let passengersMarkers = [];
  let currentLocation = null;
  let selectedDriver = null;
  let currentTrip = null;
  let routeControl = null;

  // Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ù…Ø®ØµØµØ© Ù„Ù„Ø®Ø±ÙŠØ·Ø©
  const driverIcon = L.divIcon({
    html: 'ğŸš—',
    iconSize: [30, 30],
    className: 'custom-div-icon'
  });

  const passengerIcon = L.divIcon({
    html: 'ğŸ§â€â™€ï¸',
    iconSize: [30, 30],
    className: 'custom-div-icon'
  });

  function showPage(id) {
    ["loginPage", "passengerPage", "driverPage", "mapPage"].forEach(p => {
      document.getElementById(p).style.display = "none";
    });
    document.getElementById(id).style.display = id === "mapPage" ? "flex" : "block";
  }

  function showMessage(type, message, pagePrefix = '') {
    const successEl = document.getElementById(pagePrefix + 'Success');
    const errorEl = document.getElementById(pagePrefix + 'Error');
    
    if (type === 'success') {
      successEl.textContent = message;
      successEl.style.display = 'block';
      errorEl.style.display = 'none';
    } else {
      errorEl.textContent = message;
      errorEl.style.display = 'block';
      successEl.style.display = 'none';
    }
    
    setTimeout(() => {
      successEl.style.display = 'none';
      errorEl.style.display = 'none';
    }, 5000);
  }

  function loadMap(userName) {
    if (currentMap) {
      currentMap.remove();
    }
    
    currentMap = L.map('map').setView([28.0339, 1.6596], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(currentMap);

    // ØªØ®ØµÙŠØµ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    if (window.currentRole === 'rakib') {
      document.getElementById('passengerContent').style.display = 'block';
      document.getElementById('driverContent').style.display = 'none';
      document.getElementById('sidebarTitle').textContent = 'ğŸ§â€â™€ï¸ Ø·Ù„Ø¨ Ø±Ø­Ù„Ø©';
      document.getElementById('activateBtn').textContent = 'ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚';
    } else {
      document.getElementById('passengerContent').style.display = 'none';
      document.getElementById('driverContent').style.display = 'block';
      document.getElementById('sidebarTitle').textContent = 'ğŸš— Ù„ÙˆØ­Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚';
      document.getElementById('activateBtn').textContent = 'ğŸš— ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø©';
    }

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(position => {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        currentLocation = { lat, lng };
        currentMap.setView([lat, lng], 14);

        if (currentMarker) {
          currentMap.removeLayer(currentMarker);
        }
        
        const icon = window.currentRole === 'rakib' ? passengerIcon : driverIcon;
        currentMarker = L.marker([lat, lng], { icon }).addTo(currentMap)
          .bindPopup(`ğŸ“ ${userName}`)
          .openPopup();

        // Ø¨Ø¯Ø¡ ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹
        startLocationTracking();
      }, (error) => {
        console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹:", error);
        alert("âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹.");
      });
    } else {
      alert("âš ï¸ Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.");
    }
  }

  // ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
  function startLocationTracking() {
    if (!window.currentUser) return;

    const locationRef = window.db.ref(`locations/${window.currentUser.uid}`);
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙƒÙ„ 10 Ø«ÙˆØ§Ù†
    setInterval(() => {
      if (navigator.geolocation && currentLocation) {
        navigator.geolocation.getCurrentPosition(position => {
          const newLocation = {
            lat: position.coords.latitude,
            lng: position.coords.longitude,
            role: window.currentRole,
            name: window.currentUser.displayName,
            timestamp: Date.now(),
            status: window.currentRole === 'sayeq' ? 
              (document.getElementById('driverStatus')?.value || 'available') : 'active'
          };

          // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ Firebase
          window.db.ref(`locations/${window.currentUser.uid}`).set(newLocation);
          
          // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø­Ù„ÙŠ
          currentLocation = { lat: newLocation.lat, lng: newLocation.lng };
          
          // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
          if (currentMarker) {
            currentMarker.setLatLng([newLocation.lat, newLocation.lng]);
          }
        });
      }
    }, 10000);

    // Ù…Ø±Ø§Ù‚Ø¨Ø© Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†
    if (window.currentRole === 'rakib') {
      watchDrivers();
    } else {
      watchPassengers();
    }

    // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø§Øª
    watchTripRequests();
  }

  // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† Ù„Ù„Ø±ÙƒØ§Ø¨
  function watchDrivers() {
    const driversRef = window.db.ref('locations');
    driversRef.on('value', (snapshot) => {
      const locations = snapshot.val();
      updateDriversOnMap(locations);
      updateDriversList(locations);
    });
  }

  // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø±ÙƒØ§Ø¨ Ù„Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†
  function watchPassengers() {
    const passengersRef = window.db.ref('locations');
    passengersRef.on('value', (snapshot) => {
      const locations = snapshot.val();
      updatePassengersOnMap(locations);
    });
  }

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
  function updateDriversOnMap(locations) {
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
    driversMarkers.forEach(marker => currentMap.removeLayer(marker));
    driversMarkers = [];

    if (!locations || !currentLocation) return;

    Object.keys(locations).forEach(userId => {
      const location = locations[userId];
      if (location.role === 'sayeq' && location.status === 'available' && userId !== window.currentUser.uid) {
        const distance = calculateDistance(currentLocation, location);
        if (distance <= 10) { // Ø§Ù„Ø³Ø§Ø¦Ù‚ÙˆÙ† ÙÙŠ Ù†Ø·Ø§Ù‚ 10 ÙƒÙ…
          const marker = L.marker([location.lat, location.lng], { icon: driverIcon })
            .addTo(currentMap)
            .bindPopup(`ğŸš— ${location.name}<br>ğŸ“ Ø§Ù„Ù…Ø³Ø§ÙØ©: ${distance.toFixed(1)} ÙƒÙ…`)
            .on('click', () => selectDriverFromMap(userId, location));
          
          driversMarkers.push(marker);
        }
      }
    });
  }

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ÙƒØ§Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
  function updatePassengersOnMap(locations) {
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
    passengersMarkers.forEach(marker => currentMap.removeLayer(marker));
    passengersMarkers = [];

    if (!locations || !currentLocation) return;

    Object.keys(locations).forEach(userId => {
      const location = locations[userId];
      if (location.role === 'rakib' && userId !== window.currentUser.uid) {
        const distance = calculateDistance(currentLocation, location);
        if (distance <= 15) { // Ø§Ù„Ø±ÙƒØ§Ø¨ ÙÙŠ Ù†Ø·Ø§Ù‚ 15 ÙƒÙ…
          const marker = L.marker([location.lat, location.lng], { icon: passengerIcon })
            .addTo(currentMap)
            .bindPopup(`ğŸ§â€â™€ï¸ ${location.name}<br>ğŸ“ Ø§Ù„Ù…Ø³Ø§ÙØ©: ${distance.toFixed(1)} ÙƒÙ…`);
          
          passengersMarkers.push(marker);
        }
      }
    });
  }

  // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†
  function updateDriversList(locations) {
    const driversList = document.getElementById('driversList');
    if (!driversList || !locations || !currentLocation) return;

    const nearbyDrivers = [];
    Object.keys(locations).forEach(userId => {
      const location = locations[userId];
      if (location.role === 'sayeq' && location.status === 'available' && userId !== window.currentUser.uid) {
        const distance = calculateDistance(currentLocation, location);
        if (distance <= 10) {
          nearbyDrivers.push({ userId, location, distance });
        }
      }
    });

    // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©
    nearbyDrivers.sort((a, b) => a.distance - b.distance);

    driversList.innerHTML = '';
    if (nearbyDrivers.length === 0) {
      driversList.innerHTML = '<p style="text-align: center; color: #718096;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø§Ø¦Ù‚ÙˆÙ† Ù…ØªØ§Ø­ÙˆÙ† ÙÙŠ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</p>';
      return;
    }

    nearbyDrivers.forEach(({ userId, location, distance }) => {
      const driverCard = document.createElement('div');
      driverCard.className = 'driver-card';
      driverCard.innerHTML = `
        <div class="driver-info">
          <div class="driver-name">ğŸš— ${location.name}</div>
          <div class="driver-distance">${distance.toFixed(1)} ÙƒÙ…</div>
        </div>
        <div class="car-info">
          <div>ğŸ“± Ù…ØªØ§Ø­ Ù„Ù„ØªÙˆØ§ØµÙ„</div>
        </div>
        <div class="driver-actions">
          <button class="action-btn call-btn" onclick="callDriver('${userId}')">ğŸ“ Ø§ØªØµØ§Ù„</button>
          <button class="action-btn chat-btn" onclick="openChat('${userId}', '${location.name}')">ğŸ’¬ Ø¯Ø±Ø¯Ø´Ø©</button>
          <button class="action-btn select-btn" onclick="selectDriver('${userId}', '${location.name}', ${distance})">Ø§Ø®ØªÙŠØ§Ø±</button>
        </div>
      `;
      driversList.appendChild(driverCard);
    });
  }

  // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ù†Ù‚Ø·ØªÙŠÙ†
  function calculateDistance(pos1, pos2) {
    const R = 6371; // Ù†ØµÙ Ù‚Ø·Ø± Ø§Ù„Ø£Ø±Ø¶ Ø¨Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±
    const dLat = (pos2.lat - pos1.lat) * Math.PI / 180;
    const dLon = (pos2.lng - pos1.lng) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(pos1.lat * Math.PI / 180) * Math.cos(pos2.lat * Math.PI / 180) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³Ø§Ø¦Ù‚ Ù…Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø©
  function selectDriverFromMap(driverId, driverLocation) {
    const distance = calculateDistance(currentLocation, driverLocation);
    selectDriver(driverId, driverLocation.name, distance);
  }

  // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³Ø§Ø¦Ù‚
  function selectDriver(driverId, driverName, distance) {
    if (!window.currentUser) return;

    const destination = document.getElementById('destination').value.trim();
    const passengers = document.getElementById('passengers').value;
    const notes = document.getElementById('notes').value.trim();

    if (!destination) {
      alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙˆØ¬Ù‡Ø© Ø£ÙˆÙ„Ø§Ù‹');
      return;
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø±Ø­Ù„Ø©
    const tripRequest = {
      passengerId: window.currentUser.uid,
      passengerName: window.currentUser.displayName,
      driverId: driverId,
      driverName: driverName,
      destination: destination,
      passengers: parseInt(passengers),
      notes: notes,
      distance: distance.toFixed(1),
      status: 'pending',
      timestamp: Date.now(),
      passengerLocation: currentLocation
    };

    // Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Firebase
    const tripRef = window.db.ref('tripRequests').push();
    tripRef.set(tripRequest).then(() => {
      selectedDriver = driverId;
      showNotification('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨', `ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø±Ø­Ù„Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø§Ø¦Ù‚ ${driverName}. ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø±Ø¯...`, 'info');
      
      // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø±Ø¯ Ø§Ù„Ø³Ø§Ø¦Ù‚
      tripRef.on('value', (snapshot) => {
        const trip = snapshot.val();
        if (trip && trip.status === 'accepted') {
          showNotification('ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨! ğŸ‰', `Ø§Ù„Ø³Ø§Ø¦Ù‚ ${driverName} ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ùƒ. Ø³ÙŠØµÙ„ Ø¥Ù„ÙŠÙƒ Ø®Ù„Ø§Ù„ ${trip.estimatedTime || 'Ù‚Ø±ÙŠØ¨Ø§Ù‹'}`, 'success');
          startTrip(tripRef.key, trip);
        } else if (trip && trip.status === 'rejected') {
          showNotification('ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨', `Ø§Ù„Ø³Ø§Ø¦Ù‚ ${driverName} Ø§Ø¹ØªØ°Ø± Ø¹Ù† Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø®ØªÙŠØ§Ø± Ø³Ø§Ø¦Ù‚ Ø¢Ø®Ø±.`, 'error');
          selectedDriver = null;
        }
      });
    });
  }

  // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø§Øª Ù„Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†
  function watchTripRequests() {
    if (window.currentRole !== 'sayeq') return;

    const requestsRef = window.db.ref('tripRequests');
    requestsRef.on('child_added', (snapshot) => {
      const request = snapshot.val();
      if (request.driverId === window.currentUser.uid && request.status === 'pending') {
        showTripRequestNotification(snapshot.key, request);
      }
    });
  }

  // Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø± Ø·Ù„Ø¨ Ø§Ù„Ø±Ø­Ù„Ø© Ù„Ù„Ø³Ø§Ø¦Ù‚
  function showTripRequestNotification(requestId, request) {
    const notification = document.createElement('div');
    notification.className = 'notification';
    notification.innerHTML = `
      <div class="notification-title">Ø·Ù„Ø¨ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯! ğŸš—</div>
      <div class="notification-content">
        <strong>Ø§Ù„Ø±Ø§ÙƒØ¨:</strong> ${request.passengerName}<br>
        <strong>Ø§Ù„ÙˆØ¬Ù‡Ø©:</strong> ${request.destination}<br>
        <strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø±ÙƒØ§Ø¨:</strong> ${request.passengers}<br>
        <strong>Ø§Ù„Ù…Ø³Ø§ÙØ©:</strong> ${request.distance} ÙƒÙ…<br>
        ${request.notes ? `<strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${request.notes}<br>` : ''}
      </div>
      <div class="notification-actions">
        <button class="accept-btn" onclick="acceptTrip('${requestId}', '${request.passengerName}')">Ù‚Ø¨ÙˆÙ„ âœ…</button>
        <button class="reject-btn" onclick="rejectTrip('${requestId}')">Ø±ÙØ¶ âŒ</button>
      </div>
    `;
    
    document.body.appendChild(notification);
    
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø¹Ø¯ 30 Ø«Ø§Ù†ÙŠØ©
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 30000);
  }

  // Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø©
  function acceptTrip(requestId, passengerName) {
    const requestRef = window.db.ref(`tripRequests/${requestId}`);
    requestRef.update({
      status: 'accepted',
      acceptedAt: Date.now(),
      estimatedTime: '10-15 Ø¯Ù‚ÙŠÙ‚Ø©'
    }).then(() => {
      // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
      const notifications = document.querySelectorAll('.notification');
      notifications.forEach(n => n.remove());
      
      // Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©
      requestRef.once('value', (snapshot) => {
        const trip = snapshot.val();
        startTrip(requestId, trip);
      });
      
      showNotification('ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø©', `ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø±Ø­Ù„Ø© ${passengerName}. ØªÙˆØ¬Ù‡ Ø¥Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø±Ø§ÙƒØ¨.`, 'success');
    });
  }

  // Ø±ÙØ¶ Ø§Ù„Ø±Ø­Ù„Ø©
  function rejectTrip(requestId) {
    const requestRef = window.db.ref(`tripRequests/${requestId}`);
    requestRef.update({
      status: 'rejected',
      rejectedAt: Date.now()
    }).then(() => {
      // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
      const notifications = document.querySelectorAll('.notification');
      notifications.forEach(n => n.remove());
      
      showNotification('ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø±Ø­Ù„Ø©', 'ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨ Ø§Ù„Ø±Ø­Ù„Ø©.', 'info');
    });
  }

  // Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©
  function startTrip(tripId, tripData) {
    currentTrip = { id: tripId, data: tripData };
    
    // Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø­Ù„Ø©
    const tripStatus = document.getElementById('tripStatus');
    const tripStatusText = document.getElementById('tripStatusText');
    
    tripStatus.style.display = 'block';
    tripStatus.className = 'trip-status active';
    
    if (window.currentRole === 'rakib') {
      tripStatusText.innerHTML = `
        <strong>ğŸš— Ø±Ø­Ù„Ø© Ù†Ø´Ø·Ø©</strong><br>
        Ø§Ù„Ø³Ø§Ø¦Ù‚: ${tripData.driverName}<br>
        Ø§Ù„Ø­Ø§Ù„Ø©: ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚ Ø¥Ù„ÙŠÙƒ
      `;
    } else {
      tripStatusText.innerHTML = `
        <strong>ğŸ§â€â™€ï¸ Ø±Ø­Ù„Ø© Ù†Ø´Ø·Ø©</strong><br>
        Ø§Ù„Ø±Ø§ÙƒØ¨: ${tripData.passengerName}<br>
        Ø§Ù„ÙˆØ¬Ù‡Ø©: ${tripData.destination}
      `;
      
      // Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø± Ø¥Ù„Ù‰ Ø§Ù„Ø±Ø§ÙƒØ¨
      if (tripData.passengerLocation && currentLocation) {
        drawRoute(currentLocation, tripData.passengerLocation);
      }
    }
  }

  // Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø±
  function drawRoute(from, to) {
    if (routeControl) {
      currentMap.removeControl(routeControl);
    }
    
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Leaflet Routing Machine Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªØ§Ø­Ø§Ù‹
    if (typeof L.Routing !== 'undefined') {
      routeControl = L.Routing.control({
        waypoints: [
          L.latLng(from.lat, from.lng),
          L.latLng(to.lat, to.lng)
        ],
        routeWhileDragging: false,
        addWaypoints: false,
        createMarker: function() { return null; } // Ù„Ø§ Ù†Ø±ÙŠØ¯ Ø¹Ù„Ø§Ù…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
      }).addTo(currentMap);
    } else {
      // Ø±Ø³Ù… Ø®Ø· Ù…Ø³ØªÙ‚ÙŠÙ… ÙƒØ¨Ø¯ÙŠÙ„
      const polyline = L.polyline([
        [from.lat, from.lng],
        [to.lat, to.lng]
      ], { color: '#667eea', weight: 4 }).addTo(currentMap);
      
      // ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø³Ø§Ø±
      currentMap.fitBounds(polyline.getBounds());
    }
  }

  // Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³Ø§Ø¦Ù‚
  function callDriver(driverId) {
    // ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØŒ Ø³ØªØ­ØªØ§Ø¬ Ù„Ø¬Ù„Ø¨ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    window.db.ref(`users/${driverId}`).once('value', (snapshot) => {
      const driverData = snapshot.val();
      if (driverData && driverData.phone) {
        window.open(`tel:${driverData.phone}`);
      } else {
        alert('Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± Ù…ØªØ§Ø­');
      }
    });
  }

  // ÙØªØ­ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
  function openChat(userId, userName) {
    const chatContainer = document.getElementById('chatContainer');
    const chatTitle = document.getElementById('chatTitle');
    
    chatTitle.textContent = `Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¹ ${userName}`;
    chatContainer.style.display = 'flex';
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
    loadChatMessages(userId);
    
    // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    watchChatMessages(userId);
  }

  // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
  function closeChat() {
    document.getElementById('chatContainer').style.display = 'none';
  }

  // ØªØ­Ù…ÙŠÙ„ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
  function loadChatMessages(userId) {
    const chatId = [window.currentUser.uid, userId].sort().join('_');
    const messagesRef = window.db.ref(`chats/${chatId}/messages`);
    
    messagesRef.once('value', (snapshot) => {
      const messages = snapshot.val();
      const chatMessages = document.getElementById('chatMessages');
      chatMessages.innerHTML = '';
      
      if (messages) {
        Object.keys(messages).forEach(messageId => {
          const message = messages[messageId];
          displayMessage(message);
        });
      }
    });
  }

  // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
  function watchChatMessages(userId) {
    const chatId = [window.currentUser.uid, userId].sort().join('_');
    const messagesRef = window.db.ref(`chats/${chatId}/messages`);
    
    messagesRef.on('child_added', (snapshot) => {
      const message = snapshot.val();
      displayMessage(message);
    });
  }

  // Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
  function displayMessage(message) {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${message.senderId === window.currentUser.uid ? 'sent' : 'received'}`;
    messageDiv.textContent = message.text;
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
  function sendMessage() {
    const chatInput = document.getElementById('chatInput');
    const messageText = chatInput.value.trim();
    
    if (!messageText) return;
    
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¢Ø®Ø± Ù…Ù† Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
    const chatTitle = document.getElementById('chatTitle').textContent;
    const otherUserId = selectedDriver; // Ø£Ùˆ ÙŠÙ…ÙƒÙ† ØªØ®Ø²ÙŠÙ†Ù‡ ÙÙŠ Ù…ØªØºÙŠØ± Ø¹Ø§Ù…
    
    if (!otherUserId) return;
    
    const chatId = [window.currentUser.uid, otherUserId].sort().join('_');
    const messageRef = window.db.ref(`chats/${chatId}/messages`).push();
    
    const message = {
      senderId: window.currentUser.uid,
      senderName: window.currentUser.displayName,
      text: messageText,
      timestamp: Date.now()
    };
    
    messageRef.set(message).then(() => {
      chatInput.value = '';
    });
  }

  // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
  function showNotification(title, content, type = 'info') {
    const notification = document.createElement('div');
    notification.className = 'notification';
    
    let bgColor = '#667eea';
    if (type === 'success') bgColor = '#48bb78';
    if (type === 'error') bgColor = '#e53e3e';
    
    notification.style.borderRightColor = bgColor;
    notification.innerHTML = `
      <div class="notification-title">${title}</div>
      <div class="notification-content">${content}</div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 5000);
  }

  // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚
  function updateDriverStatus() {
    if (window.currentRole !== 'sayeq' || !window.currentUser) return;
    
    const status = document.getElementById('driverStatus').value;
    const locationRef = window.db.ref(`locations/${window.currentUser.uid}`);
    
    locationRef.update({ status: status });
  }

  function validatePhone(phone) {
    const phoneRegex = /^(06|07|05)\d{8}$/;
    return phoneRegex.test(phone);
  }

  function submitPassengerInfo() {
    const name = document.getElementById("passengerName").value.trim();
    const phone = document.getElementById("passengerPhone").value.trim();
    const idCard = document.getElementById("passengerIdCard").files[0];
    
    if (!name) {
      showMessage('error', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„', 'passenger');
      return;
    }
    
    if (!phone || !validatePhone(phone)) {
      showMessage('error', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ ØµØ­ÙŠØ­', 'passenger');
      return;
    }
    
    if (!idCard) {
      showMessage('error', 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù‡ÙˆÙŠØ©', 'passenger');
      return;
    }
    
    // Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±Ø§ÙƒØ¨ ÙÙŠ Firebase
    const userRef = window.db.ref(`users/${window.currentUser.uid}`);
    userRef.update({
      phone: phone,
      fullName: name,
      profileComplete: true
    });
    
    showMessage('success', 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!', 'passenger');
    
    setTimeout(() => {
      showPage("mapPage");
      loadMap(name);
    }, 1500);
  }

  function startDriverMap() {
    const name = document.getElementById("driverName").value.trim();
    const phone = document.getElementById("driverPhone").value.trim();
    const carType = document.getElementById("carType").value.trim();
    const carColor = document.getElementById("carColor").value.trim();
    const plateNumber = document.getElementById("plateNumber").value.trim();
    const driverId = document.getElementById("driverId").files[0];
    const carCheck = document.getElementById("carCheck").files[0];
    
    if (!name || !phone || !carType || !carColor || !plateNumber) {
      showMessage('error', 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'driver');
      return;
    }
    
    if (!validatePhone(phone)) {
      showMessage('error', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ ØµØ­ÙŠØ­', 'driver');
      return;
    }
    
    if (!driverId || !carCheck) {
      showMessage('error', 'ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'driver');
      return;
    }
    
    // Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙÙŠ Firebase
    const userRef = window.db.ref(`users/${window.currentUser.uid}`);
    userRef.update({
      phone: phone,
      fullName: name,
      carType: carType,
      carColor: carColor,
      plateNumber: plateNumber,
      profileComplete: true
    });
    
    showMessage('success', 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!', 'driver');
    
    setTimeout(() => {
      showPage("mapPage");
      loadMap(name);
    }, 1500);
  }

  function showDeclaration() {
    const name = document.getElementById("driverName").value.trim();
    if (!name) {
      showMessage('error', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… Ø£ÙˆÙ„Ø§Ù‹', 'driver');
      return;
    }
    
    const declarationBox = document.getElementById("declarationBox");
    declarationBox.style.display = "block";
    declarationBox.innerHTML = `
      <h4>ØªØ¹Ù‡Ø¯ Ø§Ù„Ø³Ø§Ø¦Ù‚</h4>
      <p>Ø£Ù†Ø§ Ø§Ù„Ù…ØªØ¹Ù‡Ø¯ Ø§Ù„Ø³ÙŠØ¯/Ø© <strong>${name}</strong> Ø£Ù‚Ø± ÙˆØ£ØªØ¹Ù‡Ø¯ Ø¨Ù…Ø§ ÙŠÙ„ÙŠ:</p>
      <ul style="text-align: right; line-height: 1.8;">
        <li>Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ù‚ÙˆØ§Ù†ÙŠÙ† Ø§Ù„Ù…Ø±ÙˆØ± ÙˆØ§Ù„Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</li>
        <li>Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© Ø¹Ù„Ù‰ Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø±ÙƒØ§Ø¨</li>
        <li>Ø¹Ø¯Ù… Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© ØªØ­Øª ØªØ£Ø«ÙŠØ± Ø£ÙŠ Ù…ÙˆØ§Ø¯ Ù…Ø®Ø¯Ø±Ø© Ø£Ùˆ ÙƒØ­ÙˆÙ„ÙŠØ©</li>
        <li>Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ù†ØµØ©</li>
        <li>Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ø¨Ø£Ø¯Ø¨ ÙˆØ§Ø­ØªØ±Ø§Ù… Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±ÙƒØ§Ø¨</li>
      </ul>
      <p><strong>Ø§Ù„ØªÙˆÙ‚ÙŠØ¹:</strong> ${name}</p>
      <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${new Date().toLocaleDateString('ar-DZ')}</p>
    `;
  }

  function activateRide() {
    if (window.currentRole === 'rakib') {
      const destination = document.getElementById("destination").value.trim();
      const passengers = document.getElementById("passengers").value;
      
      if (!destination) {
        alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙˆØ¬Ù‡Ø©");
        return;
      }
      
      if (!passengers || passengers < 1 || passengers > 8) {
        alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ø¯Ø¯ ØµØ­ÙŠØ­ Ù„Ù„Ø±ÙƒØ§Ø¨ (1-8)");
        return;
      }
      
      alert(`ğŸ” Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚ÙŠÙ† Ù…ØªØ§Ø­ÙŠÙ† ÙÙŠ Ù…Ù†Ø·Ù‚ØªÙƒ...`);
    } else {
      // ØªÙØ¹ÙŠÙ„ Ø®Ø¯Ù…Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚
      const availableSeats = document.getElementById("availableSeats").value;
      const driverNotes = document.getElementById("driverNotes").value.trim();
      
      if (!availableSeats || availableSeats < 1 || availableSeats > 8) {
        alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ø¯Ø¯ ØµØ­ÙŠØ­ Ù„Ù„Ù…Ù‚Ø§Ø¹Ø¯ Ø§Ù„Ù…ØªØ§Ø­Ø© (1-8)");
        return;
      }
      
      // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¥Ù„Ù‰ Ù…ØªØ§Ø­
      document.getElementById('driverStatus').value = 'available';
      updateDriverStatus();
      
      alert(`ğŸš— ØªÙ… ØªÙØ¹ÙŠÙ„ Ø®Ø¯Ù…ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­! Ø£Ù†Øª Ø§Ù„Ø¢Ù† Ù…ØªØ§Ø­ Ù„Ù„Ø±ÙƒØ§Ø¨.`);
    }
  }

  function logout() {
    if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) {
      // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      if (window.currentUser) {
        window.db.ref(`locations/${window.currentUser.uid}`).remove();
      }
      
      localStorage.clear();
      if (currentMap) {
        currentMap.remove();
        currentMap = null;
      }
      
      // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Firebase
      window.auth.signOut();
      
      showPage("loginPage");
    }
  }

  // ØªØ­Ø³ÙŠÙ† ØªØ¬Ø±Ø¨Ø© Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª
  document.addEventListener('DOMContentLoaded', function() {
    const fileInputs = document.querySelectorAll('input[type="file"]');
    fileInputs.forEach(input => {
      input.addEventListener('change', function() {
        const label = document.querySelector(`label[for="${this.id}"]`);
        if (this.files.length > 0) {
          label.style.borderColor = '#48bb78';
          label.style.backgroundColor = '#f0fff4';
          label.innerHTML = `âœ… ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù: ${this.files[0].name}`;
        }
      });
    });

    // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter
    document.getElementById('chatInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });
  });
</script>

</body>
</html>
